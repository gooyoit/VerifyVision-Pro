{% extends 'base.html' %}

{% block title %}首页 - 图像伪造检测系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- 欢迎卡片 -->
        <div class="card welcome-card mb-4">
            <div class="card-body text-center py-5">
                <div class="icon-container mb-4">
                    <i class="bi bi-shield-check display-1 text-primary"></i>
                </div>
                <h1 class="display-5 fw-bold mb-3">图像伪造检测系统</h1>
                <p class="lead mb-4">
                    使用深度学习技术帮助您检测图像是否经过篡改或人工合成
                </p>
                <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                    <a href="#detect-section" class="btn btn-primary btn-lg px-4 gap-3" id="normalDetectBtn">
                        <i class="bi bi-image me-2"></i>开始检测
                    </a>
                    <button class="btn btn-success btn-lg px-4" id="aiDetectBtn">
                        <i class="bi bi-robot me-2"></i>AI Agent检测
                    </button>
                    <a href="{{ url_for('about') }}" class="btn btn-outline-secondary btn-lg px-4">
                        <i class="bi bi-info-circle me-2"></i>了解更多
                    </a>
                </div>
            </div>
        </div>
        
        <!-- 检测卡片 -->
        <div id="detect-section" class="card">
            <div class="card-header bg-primary text-white">
                <h2 class="text-center mb-0">
                    <i class="bi bi-search me-2"></i>图像检测
                </h2>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <p class="lead">
                        上传图片以检测图像是否被伪造或篡改。系统将分析图像并给出真实或伪造的判断结果。
                    </p>
                </div>
                
                <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" id="uploadForm" class="upload-form">
                    <div class="upload-container mb-4">
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-content text-center">
                                <i class="bi bi-cloud-arrow-up-fill display-4 mb-3 text-primary"></i>
                                <h5>点击或拖放图像到此处</h5>
                                <p class="text-muted">支持JPG、JPEG和PNG格式，最大16MB</p>
                            </div>
                            <input type="file" class="form-control visually-hidden" id="file" name="file" accept=".jpg,.jpeg,.png" required>
                        </div>
                    </div>
                    
                    <div class="image-preview-container text-center mt-4 d-none" id="imagePreviewContainer">
                        <!-- 由JavaScript填充内容 -->
                    </div>
                    
                    <div class="d-grid gap-2 col-md-6 mx-auto mt-4">
                        <button class="btn btn-primary btn-lg" type="submit" id="uploadBtn">
                            <span id="uploadBtnText">上传并检测</span>
                            <span id="uploadSpinner" class="spinner-border spinner-border-sm d-none ms-2" role="status" aria-hidden="true"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- AI智能检测卡片 -->
        <div class="card mt-4 d-none" id="aiDetectSection">
            <div class="card-header bg-success text-white">
                <h2 class="text-center mb-0">
                    <i class="bi bi-robot me-2"></i>AI Agent检测
                </h2>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <p class="lead">
                        上传图片并输入您的问题，AI将对图像进行详细分析并提供实时流式回答。
                    </p>
                </div>
                
                <form id="aiDetectionForm" class="ai-detection-form">
                    <!-- 图片上传区域 -->
                    <div class="upload-container mb-4">
                        <div class="upload-area" id="aiUploadArea">
                            <div class="upload-content text-center">
                                <i class="bi bi-cloud-arrow-up-fill display-4 mb-3 text-success"></i>
                                <h5>点击或拖放图像到此处</h5>
                                <p class="text-muted">支持JPG、JPEG和PNG格式，最大16MB</p>
                            </div>
                            <input type="file" class="form-control visually-hidden" id="aiFile" name="file" accept=".jpg,.jpeg,.png" required>
                        </div>
                    </div>
                    
                    <div class="image-preview-container text-center mt-4 d-none" id="aiImagePreviewContainer">
                        <!-- 由JavaScript填充内容 -->
                    </div>
                    
                    <!-- 问题输入区域 -->
                    <div class="mb-4">
                        <label for="queryInput" class="form-label fw-bold">
                            <i class="bi bi-question-circle me-2"></i>您想了解什么？
                        </label>
                        <textarea 
                            class="form-control" 
                            id="queryInput" 
                            name="query" 
                            rows="3" 
                            placeholder="请输入您想要询问的问题，例如：这张图片是否被篡改过？有哪些可疑的地方？"
                            required>请分析这张图片是否为伪造图片，并详细说明理由</textarea>
                        <div class="form-text">
                            <i class="bi bi-lightbulb me-1"></i>
                            提示：您可以询问图像真伪、篡改痕迹、技术细节等任何相关问题
                        </div>
                    </div>
                    
                    <!-- 提交按钮 -->
                    <div class="d-grid gap-2 col-md-6 mx-auto">
                        <button class="btn btn-success btn-lg" type="submit" id="aiDetectionBtn">
                            <span id="aiDetectionBtnText">
                                <i class="bi bi-send me-2"></i>开始AI分析
                            </span>
                            <span id="aiDetectionSpinner" class="spinner-border spinner-border-sm d-none ms-2" role="status" aria-hidden="true"></span>
                        </button>
                    </div>
                </form>
                
                <!-- AI响应结果区域 -->
                <div class="mt-4 d-none" id="aiResponseContainer">
                    <div class="card border-success">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="bi bi-robot text-success me-2"></i>AI分析结果
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="aiResponseContent" class="ai-response-content">
                                <!-- AI响应内容将在这里实时显示 -->
                            </div>
                            <div id="aiResponseStatus" class="mt-2 text-muted">
                                <i class="bi bi-hourglass-split"></i> 正在分析中...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 功能特点卡片 -->
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h3 class="mb-0">
                    <i class="bi bi-info-circle me-2"></i>使用说明
                </h3>
            </div>
            <div class="card-body">
                <div class="row features-container">
                    <div class="col-md-6 mb-4">
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="bi bi-upload"></i>
                            </div>
                            <div class="feature-content">
                                <h5>上传图像</h5>
                                <p>点击上传区域选择要检测的图像文件</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="bi bi-gpu-card"></i>
                            </div>
                            <div class="feature-content">
                                <h5>AI分析</h5>
                                <p>深度学习模型自动分析图像特征</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="bi bi-check-circle"></i>
                            </div>
                            <div class="feature-content">
                                <h5>检测结果</h5>
                                <p>获取图像真伪的详细分析结果</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="bi bi-shield-lock"></i>
                            </div>
                            <div class="feature-content">
                                <h5>隐私保护</h5>
                                <p>上传的图像仅用于检测，不会存储</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-warning mt-3">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>注意：</strong> 系统基于深度学习模型进行检测，可能存在一定的误判率。检测结果仅供参考，最终判断请结合专业知识和其他证据。
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* 首页特定样式 */
    .welcome-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9f2ff 100%);
        border-radius: 20px;
    }
    
    .icon-container {
        background-color: rgba(63, 106, 216, 0.1);
        width: 120px;
        height: 120px;
        border-radius: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
    }
    
    .upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 12px;
        padding: 2rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: block;
    }
    
    .upload-area:hover, .upload-area.dragover {
        border-color: var(--primary-color);
        background-color: rgba(63, 106, 216, 0.05);
    }
    
    .feature-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-radius: 10px;
        transition: all 0.3s ease;
        background-color: #f8f9fa;
        height: 100%;
    }
    
    .feature-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .feature-icon {
        width: 50px;
        height: 50px;
        border-radius: 25px;
        background: var(--primary-gradient);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-right: 1rem;
        flex-shrink: 0;
    }
    
    .feature-content {
        flex-grow: 1;
    }
    
    .feature-content h5 {
        margin-bottom: 0.5rem;
        color: var(--dark-color);
    }
    
    .feature-content p {
        margin-bottom: 0;
        color: var(--secondary-color);
    }
    
    /* AI检测模块样式 */
    .ai-detection-form .upload-area {
        border: 2px dashed #28a745;
        border-radius: 12px;
        padding: 2rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: block;
    }
    
    .ai-detection-form .upload-area:hover, 
    .ai-detection-form .upload-area.dragover {
        border-color: #28a745;
        background-color: rgba(40, 167, 69, 0.05);
    }
    
    .ai-detection-form .upload-area.file-selected {
        border-color: #28a745;
        background-color: rgba(40, 167, 69, 0.1);
        border-style: solid;
    }
    
    /* 清除原有的ai-response-content样式干扰 */
    .ai-response-content {
        background-color: #ffffff;
        border-radius: 8px;
        padding: 1rem;
        min-height: 100px;
        max-height: 500px;
        overflow-y: auto;
        border: 1px solid #e9ecef;
        /* 移除可能干扰的样式 */
    }
    
    .ai-response-content.streaming {
        animation: pulse 2s infinite;
    }
    
    /* 步骤信息样式 */
    .step-info {
        font-weight: 500;
        color: #0d6efd;
        background-color: #f8f9fa;
        border-radius: 8px;
        animation: fadeIn 0.3s ease-in;
        padding: 8px 12px;
        margin-bottom: 8px;
        border-left: 3px solid #0d6efd;
    }
    
    @keyframes pulse {
        0% { border-color: #28a745; }
        50% { border-color: #20c997; }
        100% { border-color: #28a745; }
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    #ai-content-area {
        background-color: #ffffff !important;
        border: 1px solid #dee2e6 !important;
        border-radius: 6px;
        padding: 16px !important;
        min-height: 100px;
        max-height: 500px;
        overflow-y: auto;
        animation: fadeIn 0.5s ease-in;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif !important;
        font-size: 14px !important;
        line-height: 1.6 !important;
        color: #24292e !important;
    }
    
    /* 清除所有可能的样式继承 */
    #ai-content-area * {
        font-family: inherit;
    }
    
    /* Markdown基础样式 */
    #ai-content-area h1 {
        color: inherit !important;
        font-size: 24px !important;
        font-weight: 400 !important; /* 确保标题不加粗 */
        margin: 0 0 16px 0 !important;
        padding: 0 0 8px 0 !important;
        border-bottom: 2px solid #e1e4e8;
    }
    
    #ai-content-area h2 {
        color: inherit !important;
        font-size: 20px !important;
        font-weight: 400 !important; /* 确保标题不加粗 */
        margin: 24px 0 16px 0 !important;
        padding: 0 !important;
    }
    
    #ai-content-area h3 {
        color: inherit !important;
        font-size: 18px !important;
        font-weight: 400 !important; /* 确保标题不加粗 */
        margin: 20px 0 12px 0 !important;
        padding: 0 !important;
    }
    
    #ai-content-area h4 {
        color: inherit !important;
        font-size: 16px !important;
        font-weight: 400 !important; /* 确保标题不加粗 */
        margin: 16px 0 12px 0 !important;
        padding: 0 !important;
    }
    
    #ai-content-area h5 {
        color: inherit !important;
        font-size: 14px !important;
        font-weight: 400 !important; /* 确保标题不加粗 */
        margin: 16px 0 8px 0 !important;
        padding: 0 !important;
    }
    
    #ai-content-area h6 {
        color: inherit !important;
        font-size: 13px !important;
        font-weight: 400 !important; /* 确保标题不加粗 */
        margin: 16px 0 8px 0 !important;
        padding: 0 !important;
    }
    
    /* 统一再次声明，防止其他层叠样式影响（如 UA/Bootstrap） */
    #ai-content-area h1,
    #ai-content-area h2,
    #ai-content-area h3,
    #ai-content-area h4,
    #ai-content-area h5,
    #ai-content-area h6 {
        font-weight: 400 !important;
        font-style: normal !important;
    }

    /* 提升优先级：标题内所有子元素也保持非粗体，只有 strong 例外 */
    #ai-content-area h1 *,
    #ai-content-area h2 *,
    #ai-content-area h3 *,
    #ai-content-area h4 *,
    #ai-content-area h5 *,
    #ai-content-area h6 * {
        font-weight: 400 !important;
    }

    /* 只有 strong 加粗且为红色 */
    #ai-content-area h1 strong,
    #ai-content-area h2 strong,
    #ai-content-area h3 strong,
    #ai-content-area h4 strong,
    #ai-content-area h5 strong,
    #ai-content-area h6 strong,
    #ai-content-area strong {
        color: #dc3545 !important;
        font-weight: 700 !important;
    }
    
    /* 防止 <b> 影响：统一不加粗，仅 strong 加粗 */
    #ai-content-area b {
        font-weight: 400 !important;
        color: inherit !important;
    }
    
    /* 仅 strong 需要加粗且为红色（包括标题里的 strong） */
    #ai-content-area h1 strong,
    #ai-content-area h2 strong,
    #ai-content-area h3 strong,
    #ai-content-area h4 strong,
    #ai-content-area h5 strong,
    #ai-content-area h6 strong {
        color: #dc3545 !important;
        font-weight: 700 !important;
    }
    
    #ai-content-area p {
        color: #212529 !important;
        font-size: 14px !important;
        font-weight: 400 !important;
        line-height: 1.6 !important;
        margin: 0 0 16px 0 !important;
        padding: 0 !important;
    }
    
    /* 普通文字颜色：跟随容器，避免强制绿色或其他颜色 */
    #ai-content-area,
    #ai-content-area * {
        color: inherit !important;
    }
    
    /* 只对特定元素设置颜色 */
    #ai-content-area h1 {
        color: inherit !important;
        font-size: 24px !important;
        font-weight: 600 !important;
        margin: 0 0 16px 0 !important;
        padding: 0 0 8px 0 !important;
        border-bottom: 2px solid #e1e4e8;
    }
    
    #ai-content-area h2 {
        color: inherit !important;
        font-size: 20px !important;
        font-weight: 600 !important;
        margin: 24px 0 16px 0 !important;
        padding: 0 !important;
    }
    
    #ai-content-area h3 {
        color: inherit !important;
        font-size: 18px !important;
        font-weight: 600 !important;
        margin: 20px 0 12px 0 !important;
        padding: 0 !important;
    }
    
    #ai-content-area strong {
        color: #dc3545 !important;
        font-weight: 700 !important;
        background: none !important;
        padding: 0 !important;
        border-radius: 0 !important;
    }
    
    #ai-content-area em {
        color: inherit !important;
        font-style: italic !important;
        font-weight: 400 !important;
    }
    
    #ai-content-area ul,
    #ai-content-area ol {
        color: inherit !important;
        padding-left: 24px !important;
        margin: 0 0 16px 0 !important;
    }
    
    #ai-content-area li {
        color: inherit !important;
        font-size: 14px !important;
        font-weight: 400 !important;
        line-height: 1.6 !important;
        margin: 4px 0 !important;
    }
    
    #ai-content-area li strong {
        color: #dc3545 !important;
        font-weight: 700 !important;
        background: none !important;
        padding: 0 !important;
        border-radius: 0 !important;
    }
    
    #ai-content-area code {
        background-color: rgba(27, 31, 36, 0.05);
        color: #e83e8c !important;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 12px !important;
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace !important;
        font-weight: 400 !important;
    }
    
    #ai-content-area pre {
        background-color: #f6f8fa;
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        padding: 16px;
        overflow-x: auto;
        margin: 16px 0;
    }
    
    #ai-content-area pre code {
        background: none;
        color: #212529 !important;
        padding: 0;
        font-size: 12px !important;
    }
    
    #ai-content-area blockquote {
        border-left: 4px solid #dfe2e5;
        background-color: #f8f9fa;
        padding: 12px 16px;
        margin: 16px 0;
        color: #6a737d !important;
        font-style: italic;
    }
    
    #ai-content-area hr {
        border: none;
        border-top: 2px solid #e1e4e8;
        margin: 24px 0;
        height: 0;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- 使用本地Markdown解析库 -->
<script src="{{ url_for('static', filename='js/marked.min.js') }}"></script>
<script>
    // 配置Markdown解析器
    marked.setOptions({
        breaks: true,        // 支持换行符转换为<br>
        gfm: true,          // 启用GitHub风格的Markdown
        sanitize: false,     // 允许HTML标签
        smartLists: true,    // 智能列表处理
        smartypants: false,  // 禁用智能标点符号转换
        mangle: false,       // 禁用mangle避免警告
        headerIds: false     // 禁用headerIds避免警告
    });
    
    // 检查marked.js是否已加载
    function isMarkedLoaded() {
        return typeof marked !== 'undefined' && typeof marked.parse === 'function';
    }

    // 智能拼接：默认直接拼接；仅在关键 Markdown 边界上补必要换行
    function appendMarkdownSmart(buffer, addition) {
        const b = buffer || '';
        const a = addition || '';
        if (!b) return a;
        if (!a) return b;
        // 分隔线后紧跟标题时，补双换行
        if (/---\s*$/.test(b) && /^\s*#{1,6}\s/.test(a)) {
            return b.replace(/\s*$/, '') + '\n\n' + a.replace(/^\s*/, '');
        }
        // 当下一个块是块级 Markdown 起始而前一个不以换行结尾时，补单换行
        const startsBlock = /^(\s*(#{1,6}\s|[-*+]\s|\d+\.\s|```|>|\|))/.test(a);
        if (!b.endsWith('\n') && startsBlock) {
            return b + '\n' + a;
        }
        return b + a;
    }
    
    // 使用本地marked.js库的渲染函数
    function renderMarkdownContent(content) {
        if (!content || !content.trim()) return '';
        
        console.log('=== Markdown渲染调试 ===');
        console.log('原始内容:', content);
        console.log('Marked库是否已加载:', isMarkedLoaded());
        
        // 预处理：规范 Markdown，避免 '---####' 等紧贴导致解析异常
        function normalizeMarkdown(src) {
            if (!src) return '';
            let text = src.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            // 1) 修复任意位置的 --- 紧跟 ####：在 --- 前后强制断成分隔线
            text = text.replace(/\s*---+\s*(?=\s*#{1,6}\s)/g, '\n\n---\n\n');
            // 2) 若非换行后紧跟标题，则在标题前补双换行（避免内联标题粘连）
            text = text.replace(/([^\n])\s*(?=#{1,6}\s)/g, '$1\n\n');
            return text;
        }
        
        content = normalizeMarkdown(content);
        
        if (isMarkedLoaded()) {
            try {
                // 使用marked.js解析
                let result = marked.parse(content);
                // 标题去粗体（兜底内联）：防止 UA/第三方样式覆盖
                result = result.replace(/<h([1-6])(\b[^>]*)>/g, '<h$1$2 style="font-weight:400 !important;">');
                // 先移除空标题（含属性版和无属性版）
                result = result.replace(/<h([1-6])(?:[^>]*)>\s*<\/h\1>/g, '');
                // 将所有标题替换为段落，保留内部 strong 等语义
                result = result.replace(/<h([1-6])\b[^>]*>([\s\S]*?)<\/h\1>/g, '<p>$2<\/p>');
                // 移除空段落
                result = result.replace(/<p>\s*<\/p>/g, '');
                console.log('Marked.js解析成功，结果长度:', result.length);
                console.log('处理后结果:', result);
                console.log('========================');
                return result;
            } catch (error) {
                console.error('Marked.js解析失败:', error);
            }
        }
        
        // 备用解析器 - 处理基础markdown格式
        console.log('使用备用解析器');
        
        // 先规范化换行符
        let result = content.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        
        // 按行处理，保持结构
        const lines = result.split('\n');
        const processedLines = [];
        
        for (let i = 0; i < lines.length; i++) {
            let line = lines[i];
            
            // 处理标题
            if (/^#{1,6}\s/.test(line)) {
                const level = line.match(/^#{1,6}/)[0].length;
                const text = line.replace(/^#{1,6}\s*/, '');
                processedLines.push(`<h${level}>${text}</h${level}>`);
            }
            // 处理分隔符
            else if (/^---+$/.test(line.trim())) {
                processedLines.push('<hr>');
            }
            // 处理普通行
            else {
                // 处理行内markdown
                let processedLine = line
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // 粗体
                    .replace(/\*([^*]+)\*/g, '<em>$1</em>')           // 斜体
                    .replace(/`([^`]+)`/g, '<code>$1</code>');        // 行内代码
                
                processedLines.push(processedLine);
            }
        }
        
        // 合并处理后的行，并处理段落
        result = processedLines.join('\n');
        
        // 将连续的非HTML行合并为段落
        result = result.replace(/^(?!<[a-zA-Z])(.*?)(?=\n(?:<[a-zA-Z]|$))/gm, function(match) {
            // 如果不是空行，包装为段落
            if (match.trim()) {
                return `<p>${match}</p>`;
            }
            return match;
        });
        
        // 清理多余的空行和修复格式
        result = result
            .replace(/\n+/g, '\n')  // 减少多余换行
            .replace(/<\/p>\n<p>/g, '</p><p>')  // 合并相邻段落
            .trim();
        
        console.log('备用解析器结果:', result);
        console.log('========================');
        return result;
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // 卡片切换功能
        const normalDetectBtn = document.getElementById('normalDetectBtn');
        const aiDetectBtn = document.getElementById('aiDetectBtn');
        const detectSection = document.getElementById('detect-section');
        const aiDetectSection = document.getElementById('aiDetectSection');
        
        // 点击开始检测按钮 - 显示普通检测，隐藏AI检测
        if (normalDetectBtn) {
            normalDetectBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                // 显示普通检测卡片，隐藏AI检测卡片
                if (detectSection) {
                    detectSection.classList.remove('d-none');
                }
                if (aiDetectSection) {
                    aiDetectSection.classList.add('d-none');
                }
                
                // 滚动到检测区域
                setTimeout(() => {
                    detectSection.scrollIntoView({ behavior: 'smooth' });
                }, 100);
            });
        }
        
        // 点击AI Agent检测按钮 - 显示AI检测，隐藏普通检测
        if (aiDetectBtn) {
            aiDetectBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                // 显示AI检测卡片，隐藏普通检测卡片
                if (aiDetectSection) {
                    aiDetectSection.classList.remove('d-none');
                }
                if (detectSection) {
                    detectSection.classList.add('d-none');
                }
                
                // 滚动到AI检测区域
                setTimeout(() => {
                    aiDetectSection.scrollIntoView({ behavior: 'smooth' });
                }, 100);
            });
        }
        
        // 拖放功能
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('file');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        
        if (uploadArea && fileInput) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                uploadArea.classList.add('dragover');
            }
            
            function unhighlight() {
                uploadArea.classList.remove('dragover');
            }
            
            uploadArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if(files.length) {
                    fileInput.files = files;
                    // 触发change事件，使文件预览功能工作
                    const event = new Event('change', { bubbles: true });
                    fileInput.dispatchEvent(event);
                }
            }
            
            // 点击上传区域时触发文件选择
            uploadArea.addEventListener('click', function(e) {
                // 只有当预览区域隐藏或点击的不是预览区域内的元素时才触发
                const isPreviewShown = !imagePreviewContainer.classList.contains('d-none');
                
                if (!isPreviewShown || !imagePreviewContainer.contains(e.target)) {
                    fileInput.click();
                }
            });
        }
        
        // AI检测功能
        const aiUploadArea = document.getElementById('aiUploadArea');
        const aiFileInput = document.getElementById('aiFile');
        const aiImagePreviewContainer = document.getElementById('aiImagePreviewContainer');
        
        if (aiUploadArea && aiFileInput) {
            // AI上传区域拖放功能
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                aiUploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                aiUploadArea.addEventListener(eventName, () => {
                    aiUploadArea.classList.add('dragover');
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                aiUploadArea.addEventListener(eventName, () => {
                    aiUploadArea.classList.remove('dragover');
                }, false);
            });
            
            aiUploadArea.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if(files.length) {
                    aiFileInput.files = files;
                    const event = new Event('change', { bubbles: true });
                    aiFileInput.dispatchEvent(event);
                }
            }, false);
            
            // 点击上传区域触发文件选择
            aiUploadArea.addEventListener('click', function(e) {
                const isPreviewShown = !aiImagePreviewContainer.classList.contains('d-none');
                if (!isPreviewShown || !aiImagePreviewContainer.contains(e.target)) {
                    aiFileInput.click();
                }
            });
            
            // 文件选择预览
            aiFileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    
                    // 添加加载指示器
                    aiImagePreviewContainer.innerHTML = '<div class="spinner-border text-success" role="status"><span class="visually-hidden">加载中...</span></div>';
                    aiImagePreviewContainer.classList.remove('d-none');
                    
                    reader.onload = function(e) {
                        // 创建图像对象以获取尺寸
                        const img = new Image();
                        img.onload = function() {
                            // 更新预览容器内容
                            aiImagePreviewContainer.innerHTML = `
                                <h5>图像预览</h5>
                                <div class="image-details mb-2">
                                    <span class="badge bg-info me-2">${file.type.split('/')[1].toUpperCase()}</span>
                                    <span class="badge bg-secondary me-2">${Math.round(file.size / 1024)} KB</span>
                                    <span class="badge bg-dark">${this.width} × ${this.height}</span>
                                </div>
                                <div class="image-preview-wrapper">
                                    <img id="aiImagePreview" class="img-fluid img-thumbnail mt-2" style="max-height: 300px;" src="${e.target.result}" alt="图像预览">
                                </div>
                                <div class="preview-actions mt-3 d-flex justify-content-between align-items-center">
                                    <button type="button" class="btn btn-sm btn-outline-secondary btn-reset-upload" onclick="clearAiPreview()">
                                        <i class="bi bi-x-circle me-1"></i>重新选择
                                    </button>
                                    <div class="preview-info text-muted">
                                        <small><i class="bi bi-info-circle me-1"></i>可输入问题后点击"开始AI分析"按钮</small>
                                    </div>
                                </div>
                            `;
                            
                            // 切换上传区域样式
                            aiUploadArea.classList.add('file-selected');
                            
                            // 添加淡入动画效果
                            const newImage = aiImagePreviewContainer.querySelector('#aiImagePreview');
                            if (newImage) {
                                newImage.style.opacity = '0';
                                setTimeout(() => {
                                    newImage.style.transition = 'opacity 0.5s ease';
                                    newImage.style.opacity = '1';
                                }, 50);
                            }
                        };
                        img.src = e.target.result;
                    };
                    
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // AI检测表单提交
        if (aiDetectionForm) {
            console.log('AI检测表单已找到'); // 调试信息
            aiDetectionForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log('表单提交事件触发'); // 调试信息
                
                const formData = new FormData(aiDetectionForm);
                console.log('表单数据:', formData.get('file'), formData.get('query')); // 调试信息
                
                if (!formData.get('file') || !formData.get('query').trim()) {
                    console.log('表单验证失败'); // 调试信息
                    alert('请上传图片并输入问题！');
                    return;
                }
                
                console.log('开始发送请求'); // 调试信息
                
                // 显示加载状态
                aiDetectionBtn.disabled = true;
                aiDetectionBtnText.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>正在分析...';
                aiDetectionSpinner.classList.remove('d-none');
                
                // 显示响应容器并清空内容
                aiResponseContainer.classList.remove('d-none');
                aiResponseContent.innerHTML = '';
                aiResponseContent.classList.add('streaming');
                aiResponseStatus.innerHTML = '<i class="bi bi-hourglass-split"></i> AI正在分析图像<span class="typing-indicator">...</span>';
                
                // 状态管理
                let currentPhase = 'progress'; // progress -> content
                let contentBuffer = '';
                let partialLine = ''; // 用于处理不完整的行
                
                try {
                    console.log('发送fetch请求到/api/ai/predict/stream'); // 调试信息
                    const response = await fetch('/api/ai/predict/stream', {
                        method: 'POST',
                        body: formData
                    });
                    
                    console.log('收到响应:', response.status, response.ok); // 调试信息
                    
                    if (!response.ok) {
                        throw new Error('网络请求失败：' + response.status);
                    }
                    
                    console.log('开始读取流式响应'); // 调试信息
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        console.log('读取chunk:', done, value ? value.length : 0); // 调试信息
                        if (done) break;
                        
                        const chunk = decoder.decode(value, { stream: true });
                        console.log('解码后的chunk内容:', JSON.stringify(chunk)); // 调试信息
                        
                        // 将新的chunk与之前的不完整行合并
                        const fullData = partialLine + chunk;
                        const lines = fullData.split('\n\n'); // 使用双换行符分割
                        console.log('分割后的行数:', lines.length, '行内容:', lines); // 调试信息
                        
                        // 保存最后一行（可能不完整）
                        partialLine = lines.pop() || '';
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                console.log('接收到数据:', data); // 调试信息
                                
                                if (data === '[DONE]') {
                                    // 流结束
                                    console.log('流结束'); // 调试信息
                                    aiResponseContent.classList.remove('streaming');
                                    aiResponseStatus.innerHTML = '<i class="bi bi-check-circle text-success"></i> 分析完成';
                                    break;
                                } else if (data.trim()) {
                                    // 检测是否为步骤进度信息
                                    if (data.includes('步骤') && (data.includes('🚀') || data.includes('✅') || data.includes('🤖') || data.includes('📁') || data.includes('🔍') || data.includes('💭'))) {
                                        console.log('步骤信息:', data); // 调试信息
                                        // 这是步骤信息，直接添加到内容区域
                                        const stepDiv = document.createElement('div');
                                        stepDiv.className = 'step-info mb-2 p-2 bg-light border-start border-primary border-3';
                                        stepDiv.innerHTML = data;
                                        aiResponseContent.appendChild(stepDiv);
                                        
                                        // 如果是"步骤5：正在生成AI分析报告"，切换到内容模式
                                        if (data.includes('💭 步骤5：正在生成AI分析报告')) {
                                            console.log('切换到内容模式'); // 调试信息
                                            currentPhase = 'content';
                                            // 创建内容显示区域
                                            const contentDiv = document.createElement('div');
                                            contentDiv.id = 'ai-content-area';
                                            contentDiv.className = 'mt-3';
                                            console.log('创建AI内容区域，元素ID:', contentDiv.id);
                                            aiResponseContent.appendChild(contentDiv);
                                        }
                                    } else if (data.startsWith('FULL:')) {
                                        console.log('FULL内容:', data.substring(5)); // 调试信息
                                        // 完整内容替换
                                        const content = data.substring(5); // 移除 'FULL:' 前缀
                                        const contentArea = document.getElementById('ai-content-area');
                                        if (contentArea) {
                                            contentBuffer = content;
                                            const renderedHtml = renderMarkdownContent(contentBuffer);
                                            console.log('渲染后的HTML:', renderedHtml);
                                            contentArea.innerHTML = renderedHtml;
                                        } else {
                                            console.error('找不到ai-content-area元素');
                                        }
                                    } else if (data.startsWith('INCREMENT:')) {
                                        console.log('INCREMENT内容:', data.substring(10)); // 调试信息
                                        // 增量内容追加
                                        const newContent = data.substring(10); // 移除 'INCREMENT:' 前缀
                                        const contentArea = document.getElementById('ai-content-area');
                                        if (contentArea) {
                                            contentBuffer = appendMarkdownSmart(contentBuffer, newContent);
                                            const renderedHtml = renderMarkdownContent(contentBuffer);
                                            contentArea.innerHTML = renderedHtml;
                                        } else {
                                            console.error('找不到ai-content-area元素');
                                        }
                                    } else if (currentPhase === 'content') {
                                        console.log('普通内容:', data, '当前阶段:', currentPhase); // 调试信息
                                        // 兼容旧格式：这是AI分析内容，追加到内容区域
                                        const contentArea = document.getElementById('ai-content-area');
                                        if (contentArea) {
                                            contentBuffer = appendMarkdownSmart(contentBuffer, data);
                                            const renderedHtml = renderMarkdownContent(contentBuffer);
                                            contentArea.innerHTML = renderedHtml;
                                        } else {
                                            console.log('找不到ai-content-area元素，当前contentBuffer:', contentBuffer); // 调试信息
                                        }
                                    }
                                    
                                    // 自动滚动到底部
                                    aiResponseContent.scrollTop = aiResponseContent.scrollHeight;
                                }
                            }
                        }
                    }
                    
                    // 处理最后可能剩余的不完整行
                    if (partialLine.startsWith('data: ')) {
                        const data = partialLine.slice(6);
                        if (data.trim() && data !== '[DONE]') {
                            if (currentPhase === 'content') {
                                const contentArea = document.getElementById('ai-content-area');
                                if (contentArea) {
                                    contentBuffer = appendMarkdownSmart(contentBuffer, data);
                                    contentArea.innerHTML = renderMarkdownContent(contentBuffer);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('AI检测请求失败:', error);
                    aiResponseContent.classList.remove('streaming');
                    aiResponseContent.innerHTML = '<div class="text-danger"><i class="bi bi-exclamation-triangle"></i> 请求失败，请稍后重试</div>';
                    aiResponseStatus.innerHTML = '<i class="bi bi-x-circle text-danger"></i> 分析失败';
                } finally {
                    // 恢复按钮状态
                    aiDetectionBtn.disabled = false;
                    aiDetectionBtnText.innerHTML = '<i class="bi bi-send me-2"></i>开始AI分析';
                    aiDetectionSpinner.classList.add('d-none');
                }
            });
        }
        
        // 特性项动画
        const features = document.querySelectorAll('.feature-item');
        features.forEach((feature, index) => {
            feature.style.setProperty('--child-index', index);
            feature.classList.add('animate-ready');
            
            // 设置交错动画时间
            setTimeout(() => {
                feature.classList.add('animate-in');
            }, 100 * index);
        });
    });
    
    // 清除AI预览图片的全局函数
    function clearAiPreview() {
        const aiImagePreviewContainer = document.getElementById('aiImagePreviewContainer');
        const aiFileInput = document.getElementById('aiFile');
        const aiUploadArea = document.getElementById('aiUploadArea');
        
        if (aiImagePreviewContainer) {
            aiImagePreviewContainer.classList.add('d-none');
            aiImagePreviewContainer.innerHTML = '';
        }
        
        if (aiFileInput) {
            aiFileInput.value = '';
        }
        
        // 移除上传区域选中状态
        if (aiUploadArea) {
            aiUploadArea.classList.remove('file-selected');
        }
    }
    
    // 图像预览功能已经由main.js中的函数增强处理
</script>
{% endblock %} 