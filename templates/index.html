{% extends 'base.html' %}

{% block title %}é¦–é¡µ - å›¾åƒä¼ªé€ æ£€æµ‹ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- æ¬¢è¿å¡ç‰‡ -->
        <div class="card welcome-card mb-4">
            <div class="card-body text-center py-5">
                <div class="icon-container mb-4">
                    <i class="bi bi-shield-check display-1 text-primary"></i>
                </div>
                <h1 class="display-5 fw-bold mb-3">å›¾åƒä¼ªé€ æ£€æµ‹ç³»ç»Ÿ</h1>
                <p class="lead mb-4">
                    ä½¿ç”¨æ·±åº¦å­¦ä¹ æŠ€æœ¯å¸®åŠ©æ‚¨æ£€æµ‹å›¾åƒæ˜¯å¦ç»è¿‡ç¯¡æ”¹æˆ–äººå·¥åˆæˆ
                </p>
                <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                    <a href="#detect-section" class="btn btn-primary btn-lg px-4 gap-3" id="normalDetectBtn">
                        <i class="bi bi-image me-2"></i>å¼€å§‹æ£€æµ‹
                    </a>
                    <button class="btn btn-success btn-lg px-4" id="aiDetectBtn">
                        <i class="bi bi-robot me-2"></i>AI Agentæ£€æµ‹
                    </button>
                    <a href="{{ url_for('about') }}" class="btn btn-outline-secondary btn-lg px-4">
                        <i class="bi bi-info-circle me-2"></i>äº†è§£æ›´å¤š
                    </a>
                </div>
            </div>
        </div>
        
        <!-- æ£€æµ‹å¡ç‰‡ -->
        <div id="detect-section" class="card">
            <div class="card-header bg-primary text-white">
                <h2 class="text-center mb-0">
                    <i class="bi bi-search me-2"></i>å›¾åƒæ£€æµ‹
                </h2>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <p class="lead">
                        ä¸Šä¼ å›¾ç‰‡ä»¥æ£€æµ‹å›¾åƒæ˜¯å¦è¢«ä¼ªé€ æˆ–ç¯¡æ”¹ã€‚ç³»ç»Ÿå°†åˆ†æå›¾åƒå¹¶ç»™å‡ºçœŸå®æˆ–ä¼ªé€ çš„åˆ¤æ–­ç»“æœã€‚
                    </p>
                </div>
                
                <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" id="uploadForm" class="upload-form">
                    <div class="upload-container mb-4">
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-content text-center">
                                <i class="bi bi-cloud-arrow-up-fill display-4 mb-3 text-primary"></i>
                                <h5>ç‚¹å‡»æˆ–æ‹–æ”¾å›¾åƒåˆ°æ­¤å¤„</h5>
                                <p class="text-muted">æ”¯æŒJPGã€JPEGå’ŒPNGæ ¼å¼ï¼Œæœ€å¤§16MB</p>
                            </div>
                            <input type="file" class="form-control visually-hidden" id="file" name="file" accept=".jpg,.jpeg,.png" required>
                        </div>
                    </div>
                    
                    <div class="image-preview-container text-center mt-4 d-none" id="imagePreviewContainer">
                        <!-- ç”±JavaScriptå¡«å……å†…å®¹ -->
                    </div>
                    
                    <div class="d-grid gap-2 col-md-6 mx-auto mt-4">
                        <button class="btn btn-primary btn-lg" type="submit" id="uploadBtn">
                            <span id="uploadBtnText">ä¸Šä¼ å¹¶æ£€æµ‹</span>
                            <span id="uploadSpinner" class="spinner-border spinner-border-sm d-none ms-2" role="status" aria-hidden="true"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- AIæ™ºèƒ½æ£€æµ‹å¡ç‰‡ -->
        <div class="card mt-4 d-none" id="aiDetectSection">
            <div class="card-header bg-success text-white">
                <h2 class="text-center mb-0">
                    <i class="bi bi-robot me-2"></i>AI Agentæ£€æµ‹
                </h2>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <p class="lead">
                        ä¸Šä¼ å›¾ç‰‡å¹¶è¾“å…¥æ‚¨çš„é—®é¢˜ï¼ŒAIå°†å¯¹å›¾åƒè¿›è¡Œè¯¦ç»†åˆ†æå¹¶æä¾›å®æ—¶æµå¼å›ç­”ã€‚
                    </p>
                </div>
                
                <form id="aiDetectionForm" class="ai-detection-form">
                    <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
                    <div class="upload-container mb-4">
                        <div class="upload-area" id="aiUploadArea">
                            <div class="upload-content text-center">
                                <i class="bi bi-cloud-arrow-up-fill display-4 mb-3 text-success"></i>
                                <h5>ç‚¹å‡»æˆ–æ‹–æ”¾å›¾åƒåˆ°æ­¤å¤„</h5>
                                <p class="text-muted">æ”¯æŒJPGã€JPEGå’ŒPNGæ ¼å¼ï¼Œæœ€å¤§16MB</p>
                            </div>
                            <input type="file" class="form-control visually-hidden" id="aiFile" name="file" accept=".jpg,.jpeg,.png" required>
                        </div>
                    </div>
                    
                    <div class="image-preview-container text-center mt-4 d-none" id="aiImagePreviewContainer">
                        <!-- ç”±JavaScriptå¡«å……å†…å®¹ -->
                    </div>
                    
                    <!-- é—®é¢˜è¾“å…¥åŒºåŸŸ -->
                    <div class="mb-4">
                        <label for="queryInput" class="form-label fw-bold">
                            <i class="bi bi-question-circle me-2"></i>æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ
                        </label>
                        <textarea 
                            class="form-control" 
                            id="queryInput" 
                            name="query" 
                            rows="3" 
                            placeholder="è¯·è¾“å…¥æ‚¨æƒ³è¦è¯¢é—®çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šè¿™å¼ å›¾ç‰‡æ˜¯å¦è¢«ç¯¡æ”¹è¿‡ï¼Ÿæœ‰å“ªäº›å¯ç–‘çš„åœ°æ–¹ï¼Ÿ"
                            required>è¯·åˆ†æè¿™å¼ å›¾ç‰‡æ˜¯å¦ä¸ºä¼ªé€ å›¾ç‰‡ï¼Œå¹¶è¯¦ç»†è¯´æ˜ç†ç”±</textarea>
                        <div class="form-text">
                            <i class="bi bi-lightbulb me-1"></i>
                            æç¤ºï¼šæ‚¨å¯ä»¥è¯¢é—®å›¾åƒçœŸä¼ªã€ç¯¡æ”¹ç—•è¿¹ã€æŠ€æœ¯ç»†èŠ‚ç­‰ä»»ä½•ç›¸å…³é—®é¢˜
                        </div>
                    </div>
                    
                    <!-- æäº¤æŒ‰é’® -->
                    <div class="d-grid gap-2 col-md-6 mx-auto">
                        <button class="btn btn-success btn-lg" type="submit" id="aiDetectionBtn">
                            <span id="aiDetectionBtnText">
                                <i class="bi bi-send me-2"></i>å¼€å§‹AIåˆ†æ
                            </span>
                            <span id="aiDetectionSpinner" class="spinner-border spinner-border-sm d-none ms-2" role="status" aria-hidden="true"></span>
                        </button>
                    </div>
                </form>
                
                <!-- AIå“åº”ç»“æœåŒºåŸŸ -->
                <div class="mt-4 d-none" id="aiResponseContainer">
                    <div class="card border-success">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="bi bi-robot text-success me-2"></i>AIåˆ†æç»“æœ
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="aiResponseContent" class="ai-response-content">
                                <!-- AIå“åº”å†…å®¹å°†åœ¨è¿™é‡Œå®æ—¶æ˜¾ç¤º -->
                            </div>
                            <div id="aiResponseStatus" class="mt-2 text-muted">
                                <i class="bi bi-hourglass-split"></i> æ­£åœ¨åˆ†æä¸­...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- åŠŸèƒ½ç‰¹ç‚¹å¡ç‰‡ -->
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h3 class="mb-0">
                    <i class="bi bi-info-circle me-2"></i>ä½¿ç”¨è¯´æ˜
                </h3>
            </div>
            <div class="card-body">
                <div class="row features-container">
                    <div class="col-md-6 mb-4">
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="bi bi-upload"></i>
                            </div>
                            <div class="feature-content">
                                <h5>ä¸Šä¼ å›¾åƒ</h5>
                                <p>ç‚¹å‡»ä¸Šä¼ åŒºåŸŸé€‰æ‹©è¦æ£€æµ‹çš„å›¾åƒæ–‡ä»¶</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="bi bi-gpu-card"></i>
                            </div>
                            <div class="feature-content">
                                <h5>AIåˆ†æ</h5>
                                <p>æ·±åº¦å­¦ä¹ æ¨¡å‹è‡ªåŠ¨åˆ†æå›¾åƒç‰¹å¾</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="bi bi-check-circle"></i>
                            </div>
                            <div class="feature-content">
                                <h5>æ£€æµ‹ç»“æœ</h5>
                                <p>è·å–å›¾åƒçœŸä¼ªçš„è¯¦ç»†åˆ†æç»“æœ</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="bi bi-shield-lock"></i>
                            </div>
                            <div class="feature-content">
                                <h5>éšç§ä¿æŠ¤</h5>
                                <p>ä¸Šä¼ çš„å›¾åƒä»…ç”¨äºæ£€æµ‹ï¼Œä¸ä¼šå­˜å‚¨</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-warning mt-3">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>æ³¨æ„ï¼š</strong> ç³»ç»ŸåŸºäºæ·±åº¦å­¦ä¹ æ¨¡å‹è¿›è¡Œæ£€æµ‹ï¼Œå¯èƒ½å­˜åœ¨ä¸€å®šçš„è¯¯åˆ¤ç‡ã€‚æ£€æµ‹ç»“æœä»…ä¾›å‚è€ƒï¼Œæœ€ç»ˆåˆ¤æ–­è¯·ç»“åˆä¸“ä¸šçŸ¥è¯†å’Œå…¶ä»–è¯æ®ã€‚
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* é¦–é¡µç‰¹å®šæ ·å¼ */
    .welcome-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9f2ff 100%);
        border-radius: 20px;
    }
    
    .icon-container {
        background-color: rgba(63, 106, 216, 0.1);
        width: 120px;
        height: 120px;
        border-radius: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
    }
    
    .upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 12px;
        padding: 2rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: block;
    }
    
    .upload-area:hover, .upload-area.dragover {
        border-color: var(--primary-color);
        background-color: rgba(63, 106, 216, 0.05);
    }
    
    .feature-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-radius: 10px;
        transition: all 0.3s ease;
        background-color: #f8f9fa;
        height: 100%;
    }
    
    .feature-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .feature-icon {
        width: 50px;
        height: 50px;
        border-radius: 25px;
        background: var(--primary-gradient);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-right: 1rem;
        flex-shrink: 0;
    }
    
    .feature-content {
        flex-grow: 1;
    }
    
    .feature-content h5 {
        margin-bottom: 0.5rem;
        color: var(--dark-color);
    }
    
    .feature-content p {
        margin-bottom: 0;
        color: var(--secondary-color);
    }
    
    /* AIæ£€æµ‹æ¨¡å—æ ·å¼ */
    .ai-detection-form .upload-area {
        border: 2px dashed #28a745;
        border-radius: 12px;
        padding: 2rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: block;
    }
    
    .ai-detection-form .upload-area:hover, 
    .ai-detection-form .upload-area.dragover {
        border-color: #28a745;
        background-color: rgba(40, 167, 69, 0.05);
    }
    
    .ai-detection-form .upload-area.file-selected {
        border-color: #28a745;
        background-color: rgba(40, 167, 69, 0.1);
        border-style: solid;
    }
    
    /* æ¸…é™¤åŸæœ‰çš„ai-response-contentæ ·å¼å¹²æ‰° */
    .ai-response-content {
        background-color: #ffffff;
        border-radius: 8px;
        padding: 1rem;
        min-height: 100px;
        max-height: 500px;
        overflow-y: auto;
        border: 1px solid #e9ecef;
        /* ç§»é™¤å¯èƒ½å¹²æ‰°çš„æ ·å¼ */
    }
    
    .ai-response-content.streaming {
        animation: pulse 2s infinite;
    }
    
    /* æ­¥éª¤ä¿¡æ¯æ ·å¼ */
    .step-info {
        font-weight: 500;
        color: #0d6efd;
        background-color: #f8f9fa;
        border-radius: 8px;
        animation: fadeIn 0.3s ease-in;
        padding: 8px 12px;
        margin-bottom: 8px;
        border-left: 3px solid #0d6efd;
    }
    
    @keyframes pulse {
        0% { border-color: #28a745; }
        50% { border-color: #20c997; }
        100% { border-color: #28a745; }
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    #ai-content-area {
        background-color: #ffffff !important;
        border: 1px solid #dee2e6 !important;
        border-radius: 6px;
        padding: 16px !important;
        min-height: 100px;
        max-height: 500px;
        overflow-y: auto;
        animation: fadeIn 0.5s ease-in;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif !important;
        font-size: 14px !important;
        line-height: 1.6 !important;
        color: #24292e !important;
    }
    
    /* æ¸…é™¤æ‰€æœ‰å¯èƒ½çš„æ ·å¼ç»§æ‰¿ */
    #ai-content-area * {
        font-family: inherit;
    }
    
    /* MarkdownåŸºç¡€æ ·å¼ */
    #ai-content-area h1 {
        color: inherit !important;
        font-size: 24px !important;
        font-weight: 400 !important; /* ç¡®ä¿æ ‡é¢˜ä¸åŠ ç²— */
        margin: 0 0 16px 0 !important;
        padding: 0 0 8px 0 !important;
        border-bottom: 2px solid #e1e4e8;
    }
    
    #ai-content-area h2 {
        color: inherit !important;
        font-size: 20px !important;
        font-weight: 400 !important; /* ç¡®ä¿æ ‡é¢˜ä¸åŠ ç²— */
        margin: 24px 0 16px 0 !important;
        padding: 0 !important;
    }
    
    #ai-content-area h3 {
        color: inherit !important;
        font-size: 18px !important;
        font-weight: 400 !important; /* ç¡®ä¿æ ‡é¢˜ä¸åŠ ç²— */
        margin: 20px 0 12px 0 !important;
        padding: 0 !important;
    }
    
    #ai-content-area h4 {
        color: inherit !important;
        font-size: 16px !important;
        font-weight: 400 !important; /* ç¡®ä¿æ ‡é¢˜ä¸åŠ ç²— */
        margin: 16px 0 12px 0 !important;
        padding: 0 !important;
    }
    
    #ai-content-area h5 {
        color: inherit !important;
        font-size: 14px !important;
        font-weight: 400 !important; /* ç¡®ä¿æ ‡é¢˜ä¸åŠ ç²— */
        margin: 16px 0 8px 0 !important;
        padding: 0 !important;
    }
    
    #ai-content-area h6 {
        color: inherit !important;
        font-size: 13px !important;
        font-weight: 400 !important; /* ç¡®ä¿æ ‡é¢˜ä¸åŠ ç²— */
        margin: 16px 0 8px 0 !important;
        padding: 0 !important;
    }
    
    /* ç»Ÿä¸€å†æ¬¡å£°æ˜ï¼Œé˜²æ­¢å…¶ä»–å±‚å æ ·å¼å½±å“ï¼ˆå¦‚ UA/Bootstrapï¼‰ */
    #ai-content-area h1,
    #ai-content-area h2,
    #ai-content-area h3,
    #ai-content-area h4,
    #ai-content-area h5,
    #ai-content-area h6 {
        font-weight: 400 !important;
        font-style: normal !important;
    }

    /* æå‡ä¼˜å…ˆçº§ï¼šæ ‡é¢˜å†…æ‰€æœ‰å­å…ƒç´ ä¹Ÿä¿æŒéç²—ä½“ï¼Œåªæœ‰ strong ä¾‹å¤– */
    #ai-content-area h1 *,
    #ai-content-area h2 *,
    #ai-content-area h3 *,
    #ai-content-area h4 *,
    #ai-content-area h5 *,
    #ai-content-area h6 * {
        font-weight: 400 !important;
    }

    /* åªæœ‰ strong åŠ ç²—ä¸”ä¸ºçº¢è‰² */
    #ai-content-area h1 strong,
    #ai-content-area h2 strong,
    #ai-content-area h3 strong,
    #ai-content-area h4 strong,
    #ai-content-area h5 strong,
    #ai-content-area h6 strong,
    #ai-content-area strong {
        color: #dc3545 !important;
        font-weight: 700 !important;
    }
    
    /* é˜²æ­¢ <b> å½±å“ï¼šç»Ÿä¸€ä¸åŠ ç²—ï¼Œä»… strong åŠ ç²— */
    #ai-content-area b {
        font-weight: 400 !important;
        color: inherit !important;
    }
    
    /* ä»… strong éœ€è¦åŠ ç²—ä¸”ä¸ºçº¢è‰²ï¼ˆåŒ…æ‹¬æ ‡é¢˜é‡Œçš„ strongï¼‰ */
    #ai-content-area h1 strong,
    #ai-content-area h2 strong,
    #ai-content-area h3 strong,
    #ai-content-area h4 strong,
    #ai-content-area h5 strong,
    #ai-content-area h6 strong {
        color: #dc3545 !important;
        font-weight: 700 !important;
    }
    
    #ai-content-area p {
        color: #212529 !important;
        font-size: 14px !important;
        font-weight: 400 !important;
        line-height: 1.6 !important;
        margin: 0 0 16px 0 !important;
        padding: 0 !important;
    }
    
    /* æ™®é€šæ–‡å­—é¢œè‰²ï¼šè·Ÿéšå®¹å™¨ï¼Œé¿å…å¼ºåˆ¶ç»¿è‰²æˆ–å…¶ä»–é¢œè‰² */
    #ai-content-area,
    #ai-content-area * {
        color: inherit !important;
    }
    
    /* åªå¯¹ç‰¹å®šå…ƒç´ è®¾ç½®é¢œè‰² */
    #ai-content-area h1 {
        color: inherit !important;
        font-size: 24px !important;
        font-weight: 600 !important;
        margin: 0 0 16px 0 !important;
        padding: 0 0 8px 0 !important;
        border-bottom: 2px solid #e1e4e8;
    }
    
    #ai-content-area h2 {
        color: inherit !important;
        font-size: 20px !important;
        font-weight: 600 !important;
        margin: 24px 0 16px 0 !important;
        padding: 0 !important;
    }
    
    #ai-content-area h3 {
        color: inherit !important;
        font-size: 18px !important;
        font-weight: 600 !important;
        margin: 20px 0 12px 0 !important;
        padding: 0 !important;
    }
    
    #ai-content-area strong {
        color: #dc3545 !important;
        font-weight: 700 !important;
        background: none !important;
        padding: 0 !important;
        border-radius: 0 !important;
    }
    
    #ai-content-area em {
        color: inherit !important;
        font-style: italic !important;
        font-weight: 400 !important;
    }
    
    #ai-content-area ul,
    #ai-content-area ol {
        color: inherit !important;
        padding-left: 24px !important;
        margin: 0 0 16px 0 !important;
    }
    
    #ai-content-area li {
        color: inherit !important;
        font-size: 14px !important;
        font-weight: 400 !important;
        line-height: 1.6 !important;
        margin: 4px 0 !important;
    }
    
    #ai-content-area li strong {
        color: #dc3545 !important;
        font-weight: 700 !important;
        background: none !important;
        padding: 0 !important;
        border-radius: 0 !important;
    }
    
    #ai-content-area code {
        background-color: rgba(27, 31, 36, 0.05);
        color: #e83e8c !important;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 12px !important;
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace !important;
        font-weight: 400 !important;
    }
    
    #ai-content-area pre {
        background-color: #f6f8fa;
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        padding: 16px;
        overflow-x: auto;
        margin: 16px 0;
    }
    
    #ai-content-area pre code {
        background: none;
        color: #212529 !important;
        padding: 0;
        font-size: 12px !important;
    }
    
    #ai-content-area blockquote {
        border-left: 4px solid #dfe2e5;
        background-color: #f8f9fa;
        padding: 12px 16px;
        margin: 16px 0;
        color: #6a737d !important;
        font-style: italic;
    }
    
    #ai-content-area hr {
        border: none;
        border-top: 2px solid #e1e4e8;
        margin: 24px 0;
        height: 0;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- ä½¿ç”¨æœ¬åœ°Markdownè§£æåº“ -->
<script src="{{ url_for('static', filename='js/marked.min.js') }}"></script>
<script>
    // é…ç½®Markdownè§£æå™¨
    marked.setOptions({
        breaks: true,        // æ”¯æŒæ¢è¡Œç¬¦è½¬æ¢ä¸º<br>
        gfm: true,          // å¯ç”¨GitHubé£æ ¼çš„Markdown
        sanitize: false,     // å…è®¸HTMLæ ‡ç­¾
        smartLists: true,    // æ™ºèƒ½åˆ—è¡¨å¤„ç†
        smartypants: false,  // ç¦ç”¨æ™ºèƒ½æ ‡ç‚¹ç¬¦å·è½¬æ¢
        mangle: false,       // ç¦ç”¨mangleé¿å…è­¦å‘Š
        headerIds: false     // ç¦ç”¨headerIdsé¿å…è­¦å‘Š
    });
    
    // æ£€æŸ¥marked.jsæ˜¯å¦å·²åŠ è½½
    function isMarkedLoaded() {
        return typeof marked !== 'undefined' && typeof marked.parse === 'function';
    }

    // æ™ºèƒ½æ‹¼æ¥ï¼šé»˜è®¤ç›´æ¥æ‹¼æ¥ï¼›ä»…åœ¨å…³é”® Markdown è¾¹ç•Œä¸Šè¡¥å¿…è¦æ¢è¡Œ
    function appendMarkdownSmart(buffer, addition) {
        const b = buffer || '';
        const a = addition || '';
        if (!b) return a;
        if (!a) return b;
        // åˆ†éš”çº¿åç´§è·Ÿæ ‡é¢˜æ—¶ï¼Œè¡¥åŒæ¢è¡Œ
        if (/---\s*$/.test(b) && /^\s*#{1,6}\s/.test(a)) {
            return b.replace(/\s*$/, '') + '\n\n' + a.replace(/^\s*/, '');
        }
        // å½“ä¸‹ä¸€ä¸ªå—æ˜¯å—çº§ Markdown èµ·å§‹è€Œå‰ä¸€ä¸ªä¸ä»¥æ¢è¡Œç»“å°¾æ—¶ï¼Œè¡¥å•æ¢è¡Œ
        const startsBlock = /^(\s*(#{1,6}\s|[-*+]\s|\d+\.\s|```|>|\|))/.test(a);
        if (!b.endsWith('\n') && startsBlock) {
            return b + '\n' + a;
        }
        return b + a;
    }
    
    // ä½¿ç”¨æœ¬åœ°marked.jsåº“çš„æ¸²æŸ“å‡½æ•°
    function renderMarkdownContent(content) {
        if (!content || !content.trim()) return '';
        
        console.log('=== Markdownæ¸²æŸ“è°ƒè¯• ===');
        console.log('åŸå§‹å†…å®¹:', content);
        console.log('Markedåº“æ˜¯å¦å·²åŠ è½½:', isMarkedLoaded());
        
        // é¢„å¤„ç†ï¼šè§„èŒƒ Markdownï¼Œé¿å… '---####' ç­‰ç´§è´´å¯¼è‡´è§£æå¼‚å¸¸
        function normalizeMarkdown(src) {
            if (!src) return '';
            let text = src.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            // 1) ä¿®å¤ä»»æ„ä½ç½®çš„ --- ç´§è·Ÿ ####ï¼šåœ¨ --- å‰åå¼ºåˆ¶æ–­æˆåˆ†éš”çº¿
            text = text.replace(/\s*---+\s*(?=\s*#{1,6}\s)/g, '\n\n---\n\n');
            // 2) è‹¥éæ¢è¡Œåç´§è·Ÿæ ‡é¢˜ï¼Œåˆ™åœ¨æ ‡é¢˜å‰è¡¥åŒæ¢è¡Œï¼ˆé¿å…å†…è”æ ‡é¢˜ç²˜è¿ï¼‰
            text = text.replace(/([^\n])\s*(?=#{1,6}\s)/g, '$1\n\n');
            return text;
        }
        
        content = normalizeMarkdown(content);
        
        if (isMarkedLoaded()) {
            try {
                // ä½¿ç”¨marked.jsè§£æ
                let result = marked.parse(content);
                // æ ‡é¢˜å»ç²—ä½“ï¼ˆå…œåº•å†…è”ï¼‰ï¼šé˜²æ­¢ UA/ç¬¬ä¸‰æ–¹æ ·å¼è¦†ç›–
                result = result.replace(/<h([1-6])(\b[^>]*)>/g, '<h$1$2 style="font-weight:400 !important;">');
                // å…ˆç§»é™¤ç©ºæ ‡é¢˜ï¼ˆå«å±æ€§ç‰ˆå’Œæ— å±æ€§ç‰ˆï¼‰
                result = result.replace(/<h([1-6])(?:[^>]*)>\s*<\/h\1>/g, '');
                // å°†æ‰€æœ‰æ ‡é¢˜æ›¿æ¢ä¸ºæ®µè½ï¼Œä¿ç•™å†…éƒ¨ strong ç­‰è¯­ä¹‰
                result = result.replace(/<h([1-6])\b[^>]*>([\s\S]*?)<\/h\1>/g, '<p>$2<\/p>');
                // ç§»é™¤ç©ºæ®µè½
                result = result.replace(/<p>\s*<\/p>/g, '');
                console.log('Marked.jsè§£ææˆåŠŸï¼Œç»“æœé•¿åº¦:', result.length);
                console.log('å¤„ç†åç»“æœ:', result);
                console.log('========================');
                return result;
            } catch (error) {
                console.error('Marked.jsè§£æå¤±è´¥:', error);
            }
        }
        
        // å¤‡ç”¨è§£æå™¨ - å¤„ç†åŸºç¡€markdownæ ¼å¼
        console.log('ä½¿ç”¨å¤‡ç”¨è§£æå™¨');
        
        // å…ˆè§„èŒƒåŒ–æ¢è¡Œç¬¦
        let result = content.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        
        // æŒ‰è¡Œå¤„ç†ï¼Œä¿æŒç»“æ„
        const lines = result.split('\n');
        const processedLines = [];
        
        for (let i = 0; i < lines.length; i++) {
            let line = lines[i];
            
            // å¤„ç†æ ‡é¢˜
            if (/^#{1,6}\s/.test(line)) {
                const level = line.match(/^#{1,6}/)[0].length;
                const text = line.replace(/^#{1,6}\s*/, '');
                processedLines.push(`<h${level}>${text}</h${level}>`);
            }
            // å¤„ç†åˆ†éš”ç¬¦
            else if (/^---+$/.test(line.trim())) {
                processedLines.push('<hr>');
            }
            // å¤„ç†æ™®é€šè¡Œ
            else {
                // å¤„ç†è¡Œå†…markdown
                let processedLine = line
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // ç²—ä½“
                    .replace(/\*([^*]+)\*/g, '<em>$1</em>')           // æ–œä½“
                    .replace(/`([^`]+)`/g, '<code>$1</code>');        // è¡Œå†…ä»£ç 
                
                processedLines.push(processedLine);
            }
        }
        
        // åˆå¹¶å¤„ç†åçš„è¡Œï¼Œå¹¶å¤„ç†æ®µè½
        result = processedLines.join('\n');
        
        // å°†è¿ç»­çš„éHTMLè¡Œåˆå¹¶ä¸ºæ®µè½
        result = result.replace(/^(?!<[a-zA-Z])(.*?)(?=\n(?:<[a-zA-Z]|$))/gm, function(match) {
            // å¦‚æœä¸æ˜¯ç©ºè¡Œï¼ŒåŒ…è£…ä¸ºæ®µè½
            if (match.trim()) {
                return `<p>${match}</p>`;
            }
            return match;
        });
        
        // æ¸…ç†å¤šä½™çš„ç©ºè¡Œå’Œä¿®å¤æ ¼å¼
        result = result
            .replace(/\n+/g, '\n')  // å‡å°‘å¤šä½™æ¢è¡Œ
            .replace(/<\/p>\n<p>/g, '</p><p>')  // åˆå¹¶ç›¸é‚»æ®µè½
            .trim();
        
        console.log('å¤‡ç”¨è§£æå™¨ç»“æœ:', result);
        console.log('========================');
        return result;
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // å¡ç‰‡åˆ‡æ¢åŠŸèƒ½
        const normalDetectBtn = document.getElementById('normalDetectBtn');
        const aiDetectBtn = document.getElementById('aiDetectBtn');
        const detectSection = document.getElementById('detect-section');
        const aiDetectSection = document.getElementById('aiDetectSection');
        
        // ç‚¹å‡»å¼€å§‹æ£€æµ‹æŒ‰é’® - æ˜¾ç¤ºæ™®é€šæ£€æµ‹ï¼Œéšè—AIæ£€æµ‹
        if (normalDetectBtn) {
            normalDetectBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                // æ˜¾ç¤ºæ™®é€šæ£€æµ‹å¡ç‰‡ï¼Œéšè—AIæ£€æµ‹å¡ç‰‡
                if (detectSection) {
                    detectSection.classList.remove('d-none');
                }
                if (aiDetectSection) {
                    aiDetectSection.classList.add('d-none');
                }
                
                // æ»šåŠ¨åˆ°æ£€æµ‹åŒºåŸŸ
                setTimeout(() => {
                    detectSection.scrollIntoView({ behavior: 'smooth' });
                }, 100);
            });
        }
        
        // ç‚¹å‡»AI Agentæ£€æµ‹æŒ‰é’® - æ˜¾ç¤ºAIæ£€æµ‹ï¼Œéšè—æ™®é€šæ£€æµ‹
        if (aiDetectBtn) {
            aiDetectBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                // æ˜¾ç¤ºAIæ£€æµ‹å¡ç‰‡ï¼Œéšè—æ™®é€šæ£€æµ‹å¡ç‰‡
                if (aiDetectSection) {
                    aiDetectSection.classList.remove('d-none');
                }
                if (detectSection) {
                    detectSection.classList.add('d-none');
                }
                
                // æ»šåŠ¨åˆ°AIæ£€æµ‹åŒºåŸŸ
                setTimeout(() => {
                    aiDetectSection.scrollIntoView({ behavior: 'smooth' });
                }, 100);
            });
        }
        
        // æ‹–æ”¾åŠŸèƒ½
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('file');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        
        if (uploadArea && fileInput) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                uploadArea.classList.add('dragover');
            }
            
            function unhighlight() {
                uploadArea.classList.remove('dragover');
            }
            
            uploadArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if(files.length) {
                    fileInput.files = files;
                    // è§¦å‘changeäº‹ä»¶ï¼Œä½¿æ–‡ä»¶é¢„è§ˆåŠŸèƒ½å·¥ä½œ
                    const event = new Event('change', { bubbles: true });
                    fileInput.dispatchEvent(event);
                }
            }
            
            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸæ—¶è§¦å‘æ–‡ä»¶é€‰æ‹©
            uploadArea.addEventListener('click', function(e) {
                // åªæœ‰å½“é¢„è§ˆåŒºåŸŸéšè—æˆ–ç‚¹å‡»çš„ä¸æ˜¯é¢„è§ˆåŒºåŸŸå†…çš„å…ƒç´ æ—¶æ‰è§¦å‘
                const isPreviewShown = !imagePreviewContainer.classList.contains('d-none');
                
                if (!isPreviewShown || !imagePreviewContainer.contains(e.target)) {
                    fileInput.click();
                }
            });
        }
        
        // AIæ£€æµ‹åŠŸèƒ½
        const aiUploadArea = document.getElementById('aiUploadArea');
        const aiFileInput = document.getElementById('aiFile');
        const aiImagePreviewContainer = document.getElementById('aiImagePreviewContainer');
        
        if (aiUploadArea && aiFileInput) {
            // AIä¸Šä¼ åŒºåŸŸæ‹–æ”¾åŠŸèƒ½
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                aiUploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                aiUploadArea.addEventListener(eventName, () => {
                    aiUploadArea.classList.add('dragover');
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                aiUploadArea.addEventListener(eventName, () => {
                    aiUploadArea.classList.remove('dragover');
                }, false);
            });
            
            aiUploadArea.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if(files.length) {
                    aiFileInput.files = files;
                    const event = new Event('change', { bubbles: true });
                    aiFileInput.dispatchEvent(event);
                }
            }, false);
            
            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
            aiUploadArea.addEventListener('click', function(e) {
                const isPreviewShown = !aiImagePreviewContainer.classList.contains('d-none');
                if (!isPreviewShown || !aiImagePreviewContainer.contains(e.target)) {
                    aiFileInput.click();
                }
            });
            
            // æ–‡ä»¶é€‰æ‹©é¢„è§ˆ
            aiFileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    
                    // æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
                    aiImagePreviewContainer.innerHTML = '<div class="spinner-border text-success" role="status"><span class="visually-hidden">åŠ è½½ä¸­...</span></div>';
                    aiImagePreviewContainer.classList.remove('d-none');
                    
                    reader.onload = function(e) {
                        // åˆ›å»ºå›¾åƒå¯¹è±¡ä»¥è·å–å°ºå¯¸
                        const img = new Image();
                        img.onload = function() {
                            // æ›´æ–°é¢„è§ˆå®¹å™¨å†…å®¹
                            aiImagePreviewContainer.innerHTML = `
                                <h5>å›¾åƒé¢„è§ˆ</h5>
                                <div class="image-details mb-2">
                                    <span class="badge bg-info me-2">${file.type.split('/')[1].toUpperCase()}</span>
                                    <span class="badge bg-secondary me-2">${Math.round(file.size / 1024)} KB</span>
                                    <span class="badge bg-dark">${this.width} Ã— ${this.height}</span>
                                </div>
                                <div class="image-preview-wrapper">
                                    <img id="aiImagePreview" class="img-fluid img-thumbnail mt-2" style="max-height: 300px;" src="${e.target.result}" alt="å›¾åƒé¢„è§ˆ">
                                </div>
                                <div class="preview-actions mt-3 d-flex justify-content-between align-items-center">
                                    <button type="button" class="btn btn-sm btn-outline-secondary btn-reset-upload" onclick="clearAiPreview()">
                                        <i class="bi bi-x-circle me-1"></i>é‡æ–°é€‰æ‹©
                                    </button>
                                    <div class="preview-info text-muted">
                                        <small><i class="bi bi-info-circle me-1"></i>å¯è¾“å…¥é—®é¢˜åç‚¹å‡»"å¼€å§‹AIåˆ†æ"æŒ‰é’®</small>
                                    </div>
                                </div>
                            `;
                            
                            // åˆ‡æ¢ä¸Šä¼ åŒºåŸŸæ ·å¼
                            aiUploadArea.classList.add('file-selected');
                            
                            // æ·»åŠ æ·¡å…¥åŠ¨ç”»æ•ˆæœ
                            const newImage = aiImagePreviewContainer.querySelector('#aiImagePreview');
                            if (newImage) {
                                newImage.style.opacity = '0';
                                setTimeout(() => {
                                    newImage.style.transition = 'opacity 0.5s ease';
                                    newImage.style.opacity = '1';
                                }, 50);
                            }
                        };
                        img.src = e.target.result;
                    };
                    
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // AIæ£€æµ‹è¡¨å•æäº¤
        if (aiDetectionForm) {
            console.log('AIæ£€æµ‹è¡¨å•å·²æ‰¾åˆ°'); // è°ƒè¯•ä¿¡æ¯
            aiDetectionForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log('è¡¨å•æäº¤äº‹ä»¶è§¦å‘'); // è°ƒè¯•ä¿¡æ¯
                
                const formData = new FormData(aiDetectionForm);
                console.log('è¡¨å•æ•°æ®:', formData.get('file'), formData.get('query')); // è°ƒè¯•ä¿¡æ¯
                
                if (!formData.get('file') || !formData.get('query').trim()) {
                    console.log('è¡¨å•éªŒè¯å¤±è´¥'); // è°ƒè¯•ä¿¡æ¯
                    alert('è¯·ä¸Šä¼ å›¾ç‰‡å¹¶è¾“å…¥é—®é¢˜ï¼');
                    return;
                }
                
                console.log('å¼€å§‹å‘é€è¯·æ±‚'); // è°ƒè¯•ä¿¡æ¯
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                aiDetectionBtn.disabled = true;
                aiDetectionBtnText.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>æ­£åœ¨åˆ†æ...';
                aiDetectionSpinner.classList.remove('d-none');
                
                // æ˜¾ç¤ºå“åº”å®¹å™¨å¹¶æ¸…ç©ºå†…å®¹
                aiResponseContainer.classList.remove('d-none');
                aiResponseContent.innerHTML = '';
                aiResponseContent.classList.add('streaming');
                aiResponseStatus.innerHTML = '<i class="bi bi-hourglass-split"></i> AIæ­£åœ¨åˆ†æå›¾åƒ<span class="typing-indicator">...</span>';
                
                // çŠ¶æ€ç®¡ç†
                let currentPhase = 'progress'; // progress -> content
                let contentBuffer = '';
                let partialLine = ''; // ç”¨äºå¤„ç†ä¸å®Œæ•´çš„è¡Œ
                
                try {
                    console.log('å‘é€fetchè¯·æ±‚åˆ°/api/ai/predict/stream'); // è°ƒè¯•ä¿¡æ¯
                    const response = await fetch('/api/ai/predict/stream', {
                        method: 'POST',
                        body: formData
                    });
                    
                    console.log('æ”¶åˆ°å“åº”:', response.status, response.ok); // è°ƒè¯•ä¿¡æ¯
                    
                    if (!response.ok) {
                        throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼š' + response.status);
                    }
                    
                    console.log('å¼€å§‹è¯»å–æµå¼å“åº”'); // è°ƒè¯•ä¿¡æ¯
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        console.log('è¯»å–chunk:', done, value ? value.length : 0); // è°ƒè¯•ä¿¡æ¯
                        if (done) break;
                        
                        const chunk = decoder.decode(value, { stream: true });
                        console.log('è§£ç åçš„chunkå†…å®¹:', JSON.stringify(chunk)); // è°ƒè¯•ä¿¡æ¯
                        
                        // å°†æ–°çš„chunkä¸ä¹‹å‰çš„ä¸å®Œæ•´è¡Œåˆå¹¶
                        const fullData = partialLine + chunk;
                        const lines = fullData.split('\n\n'); // ä½¿ç”¨åŒæ¢è¡Œç¬¦åˆ†å‰²
                        console.log('åˆ†å‰²åçš„è¡Œæ•°:', lines.length, 'è¡Œå†…å®¹:', lines); // è°ƒè¯•ä¿¡æ¯
                        
                        // ä¿å­˜æœ€åä¸€è¡Œï¼ˆå¯èƒ½ä¸å®Œæ•´ï¼‰
                        partialLine = lines.pop() || '';
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                console.log('æ¥æ”¶åˆ°æ•°æ®:', data); // è°ƒè¯•ä¿¡æ¯
                                
                                if (data === '[DONE]') {
                                    // æµç»“æŸ
                                    console.log('æµç»“æŸ'); // è°ƒè¯•ä¿¡æ¯
                                    aiResponseContent.classList.remove('streaming');
                                    aiResponseStatus.innerHTML = '<i class="bi bi-check-circle text-success"></i> åˆ†æå®Œæˆ';
                                    break;
                                } else if (data.trim()) {
                                    // æ£€æµ‹æ˜¯å¦ä¸ºæ­¥éª¤è¿›åº¦ä¿¡æ¯
                                    if (data.includes('æ­¥éª¤') && (data.includes('ğŸš€') || data.includes('âœ…') || data.includes('ğŸ¤–') || data.includes('ğŸ“') || data.includes('ğŸ”') || data.includes('ğŸ’­'))) {
                                        console.log('æ­¥éª¤ä¿¡æ¯:', data); // è°ƒè¯•ä¿¡æ¯
                                        // è¿™æ˜¯æ­¥éª¤ä¿¡æ¯ï¼Œç›´æ¥æ·»åŠ åˆ°å†…å®¹åŒºåŸŸ
                                        const stepDiv = document.createElement('div');
                                        stepDiv.className = 'step-info mb-2 p-2 bg-light border-start border-primary border-3';
                                        stepDiv.innerHTML = data;
                                        aiResponseContent.appendChild(stepDiv);
                                        
                                        // å¦‚æœæ˜¯"æ­¥éª¤5ï¼šæ­£åœ¨ç”ŸæˆAIåˆ†ææŠ¥å‘Š"ï¼Œåˆ‡æ¢åˆ°å†…å®¹æ¨¡å¼
                                        if (data.includes('ğŸ’­ æ­¥éª¤5ï¼šæ­£åœ¨ç”ŸæˆAIåˆ†ææŠ¥å‘Š')) {
                                            console.log('åˆ‡æ¢åˆ°å†…å®¹æ¨¡å¼'); // è°ƒè¯•ä¿¡æ¯
                                            currentPhase = 'content';
                                            // åˆ›å»ºå†…å®¹æ˜¾ç¤ºåŒºåŸŸ
                                            const contentDiv = document.createElement('div');
                                            contentDiv.id = 'ai-content-area';
                                            contentDiv.className = 'mt-3';
                                            console.log('åˆ›å»ºAIå†…å®¹åŒºåŸŸï¼Œå…ƒç´ ID:', contentDiv.id);
                                            aiResponseContent.appendChild(contentDiv);
                                        }
                                    } else if (data.startsWith('FULL:')) {
                                        console.log('FULLå†…å®¹:', data.substring(5)); // è°ƒè¯•ä¿¡æ¯
                                        // å®Œæ•´å†…å®¹æ›¿æ¢
                                        const content = data.substring(5); // ç§»é™¤ 'FULL:' å‰ç¼€
                                        const contentArea = document.getElementById('ai-content-area');
                                        if (contentArea) {
                                            contentBuffer = content;
                                            const renderedHtml = renderMarkdownContent(contentBuffer);
                                            console.log('æ¸²æŸ“åçš„HTML:', renderedHtml);
                                            contentArea.innerHTML = renderedHtml;
                                        } else {
                                            console.error('æ‰¾ä¸åˆ°ai-content-areaå…ƒç´ ');
                                        }
                                    } else if (data.startsWith('INCREMENT:')) {
                                        console.log('INCREMENTå†…å®¹:', data.substring(10)); // è°ƒè¯•ä¿¡æ¯
                                        // å¢é‡å†…å®¹è¿½åŠ 
                                        const newContent = data.substring(10); // ç§»é™¤ 'INCREMENT:' å‰ç¼€
                                        const contentArea = document.getElementById('ai-content-area');
                                        if (contentArea) {
                                            contentBuffer = appendMarkdownSmart(contentBuffer, newContent);
                                            const renderedHtml = renderMarkdownContent(contentBuffer);
                                            contentArea.innerHTML = renderedHtml;
                                        } else {
                                            console.error('æ‰¾ä¸åˆ°ai-content-areaå…ƒç´ ');
                                        }
                                    } else if (currentPhase === 'content') {
                                        console.log('æ™®é€šå†…å®¹:', data, 'å½“å‰é˜¶æ®µ:', currentPhase); // è°ƒè¯•ä¿¡æ¯
                                        // å…¼å®¹æ—§æ ¼å¼ï¼šè¿™æ˜¯AIåˆ†æå†…å®¹ï¼Œè¿½åŠ åˆ°å†…å®¹åŒºåŸŸ
                                        const contentArea = document.getElementById('ai-content-area');
                                        if (contentArea) {
                                            contentBuffer = appendMarkdownSmart(contentBuffer, data);
                                            const renderedHtml = renderMarkdownContent(contentBuffer);
                                            contentArea.innerHTML = renderedHtml;
                                        } else {
                                            console.log('æ‰¾ä¸åˆ°ai-content-areaå…ƒç´ ï¼Œå½“å‰contentBuffer:', contentBuffer); // è°ƒè¯•ä¿¡æ¯
                                        }
                                    }
                                    
                                    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                                    aiResponseContent.scrollTop = aiResponseContent.scrollHeight;
                                }
                            }
                        }
                    }
                    
                    // å¤„ç†æœ€åå¯èƒ½å‰©ä½™çš„ä¸å®Œæ•´è¡Œ
                    if (partialLine.startsWith('data: ')) {
                        const data = partialLine.slice(6);
                        if (data.trim() && data !== '[DONE]') {
                            if (currentPhase === 'content') {
                                const contentArea = document.getElementById('ai-content-area');
                                if (contentArea) {
                                    contentBuffer = appendMarkdownSmart(contentBuffer, data);
                                    contentArea.innerHTML = renderMarkdownContent(contentBuffer);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('AIæ£€æµ‹è¯·æ±‚å¤±è´¥:', error);
                    aiResponseContent.classList.remove('streaming');
                    aiResponseContent.innerHTML = '<div class="text-danger"><i class="bi bi-exclamation-triangle"></i> è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
                    aiResponseStatus.innerHTML = '<i class="bi bi-x-circle text-danger"></i> åˆ†æå¤±è´¥';
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    aiDetectionBtn.disabled = false;
                    aiDetectionBtnText.innerHTML = '<i class="bi bi-send me-2"></i>å¼€å§‹AIåˆ†æ';
                    aiDetectionSpinner.classList.add('d-none');
                }
            });
        }
        
        // ç‰¹æ€§é¡¹åŠ¨ç”»
        const features = document.querySelectorAll('.feature-item');
        features.forEach((feature, index) => {
            feature.style.setProperty('--child-index', index);
            feature.classList.add('animate-ready');
            
            // è®¾ç½®äº¤é”™åŠ¨ç”»æ—¶é—´
            setTimeout(() => {
                feature.classList.add('animate-in');
            }, 100 * index);
        });
    });
    
    // æ¸…é™¤AIé¢„è§ˆå›¾ç‰‡çš„å…¨å±€å‡½æ•°
    function clearAiPreview() {
        const aiImagePreviewContainer = document.getElementById('aiImagePreviewContainer');
        const aiFileInput = document.getElementById('aiFile');
        const aiUploadArea = document.getElementById('aiUploadArea');
        
        if (aiImagePreviewContainer) {
            aiImagePreviewContainer.classList.add('d-none');
            aiImagePreviewContainer.innerHTML = '';
        }
        
        if (aiFileInput) {
            aiFileInput.value = '';
        }
        
        // ç§»é™¤ä¸Šä¼ åŒºåŸŸé€‰ä¸­çŠ¶æ€
        if (aiUploadArea) {
            aiUploadArea.classList.remove('file-selected');
        }
    }
    
    // å›¾åƒé¢„è§ˆåŠŸèƒ½å·²ç»ç”±main.jsä¸­çš„å‡½æ•°å¢å¼ºå¤„ç†
</script>
{% endblock %} 