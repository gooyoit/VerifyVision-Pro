{% extends 'base.html' %}

{% block title %}é¦–é¡µ - å›¾åƒä¼ªé€ æ£€æµ‹ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- æ¬¢è¿å¡ç‰‡ -->
        <div class="card welcome-card mb-4">
            <div class="card-body text-center py-5">
                <div class="icon-container mb-4">
                    <i class="bi bi-shield-check display-1 text-primary"></i>
                </div>
                <h1 class="display-5 fw-bold mb-3">å›¾åƒä¼ªé€ æ£€æµ‹ç³»ç»Ÿ</h1>
                <p class="lead mb-4">
                    ä½¿ç”¨æ·±åº¦å­¦ä¹ æŠ€æœ¯å¸®åŠ©æ‚¨æ£€æµ‹å›¾åƒæ˜¯å¦ç»è¿‡ç¯¡æ”¹æˆ–äººå·¥åˆæˆ
                </p>
                <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                    <a href="#detect-section" class="btn btn-primary btn-lg px-4 gap-3">
                        <i class="bi bi-image me-2"></i>å¼€å§‹æ£€æµ‹
                    </a>
                    <a href="{{ url_for('about') }}" class="btn btn-outline-secondary btn-lg px-4">
                        <i class="bi bi-info-circle me-2"></i>äº†è§£æ›´å¤š
                    </a>
                </div>
            </div>
        </div>
        
        <!-- æ£€æµ‹å¡ç‰‡ -->
        <div id="detect-section" class="card">
            <div class="card-header bg-primary text-white">
                <h2 class="text-center mb-0">
                    <i class="bi bi-search me-2"></i>å›¾åƒæ£€æµ‹
                </h2>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <p class="lead">
                        ä¸Šä¼ å›¾ç‰‡ä»¥æ£€æµ‹å›¾åƒæ˜¯å¦è¢«ä¼ªé€ æˆ–ç¯¡æ”¹ã€‚ç³»ç»Ÿå°†åˆ†æå›¾åƒå¹¶ç»™å‡ºçœŸå®æˆ–ä¼ªé€ çš„åˆ¤æ–­ç»“æœã€‚
                    </p>
                </div>
                
                <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" id="uploadForm" class="upload-form">
                    <div class="upload-container mb-4">
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-content text-center">
                                <i class="bi bi-cloud-arrow-up-fill display-4 mb-3 text-primary"></i>
                                <h5>ç‚¹å‡»æˆ–æ‹–æ”¾å›¾åƒåˆ°æ­¤å¤„</h5>
                                <p class="text-muted">æ”¯æŒJPGã€JPEGå’ŒPNGæ ¼å¼ï¼Œæœ€å¤§16MB</p>
                            </div>
                            <input type="file" class="form-control visually-hidden" id="file" name="file" accept=".jpg,.jpeg,.png" required>
                        </div>
                    </div>
                    
                    <div class="image-preview-container text-center mt-4 d-none" id="imagePreviewContainer">
                        <!-- ç”±JavaScriptå¡«å……å†…å®¹ -->
                    </div>
                    
                    <div class="d-grid gap-2 col-md-6 mx-auto mt-4">
                        <button class="btn btn-primary btn-lg" type="submit" id="uploadBtn">
                            <span id="uploadBtnText">ä¸Šä¼ å¹¶æ£€æµ‹</span>
                            <span id="uploadSpinner" class="spinner-border spinner-border-sm d-none ms-2" role="status" aria-hidden="true"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- AIæ£€æµ‹å¡ç‰‡ -->
        <div class="card mt-4">
            <div class="card-header bg-success text-white">
                <h2 class="text-center mb-0">
                    <i class="bi bi-robot me-2"></i>AIæ™ºèƒ½æ£€æµ‹
                </h2>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <p class="lead">
                        ä¸Šä¼ å›¾ç‰‡å¹¶è¾“å…¥æ‚¨çš„é—®é¢˜ï¼ŒAIå°†å¯¹å›¾åƒè¿›è¡Œè¯¦ç»†åˆ†æå¹¶æä¾›å®æ—¶æµå¼å›ç­”ã€‚
                    </p>
                </div>
                
                <form id="aiDetectionForm" class="ai-detection-form">
                    <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
                    <div class="upload-container mb-4">
                        <div class="upload-area" id="aiUploadArea">
                            <div class="upload-content text-center">
                                <i class="bi bi-cloud-arrow-up-fill display-4 mb-3 text-success"></i>
                                <h5>ç‚¹å‡»æˆ–æ‹–æ”¾å›¾åƒåˆ°æ­¤å¤„</h5>
                                <p class="text-muted">æ”¯æŒJPGã€JPEGå’ŒPNGæ ¼å¼ï¼Œæœ€å¤§16MB</p>
                            </div>
                            <input type="file" class="form-control visually-hidden" id="aiFile" name="file" accept=".jpg,.jpeg,.png" required>
                        </div>
                    </div>
                    
                    <div class="image-preview-container text-center mt-4 d-none" id="aiImagePreviewContainer">
                        <!-- ç”±JavaScriptå¡«å……å†…å®¹ -->
                    </div>
                    
                    <!-- é—®é¢˜è¾“å…¥åŒºåŸŸ -->
                    <div class="mb-4">
                        <label for="queryInput" class="form-label fw-bold">
                            <i class="bi bi-question-circle me-2"></i>æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ
                        </label>
                        <textarea 
                            class="form-control" 
                            id="queryInput" 
                            name="query" 
                            rows="3" 
                            placeholder="è¯·è¾“å…¥æ‚¨æƒ³è¦è¯¢é—®çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šè¿™å¼ å›¾ç‰‡æ˜¯å¦è¢«ç¯¡æ”¹è¿‡ï¼Ÿæœ‰å“ªäº›å¯ç–‘çš„åœ°æ–¹ï¼Ÿ"
                            required>è¯·åˆ†æè¿™å¼ å›¾ç‰‡æ˜¯å¦ä¸ºä¼ªé€ å›¾ç‰‡ï¼Œå¹¶è¯¦ç»†è¯´æ˜ç†ç”±</textarea>
                        <div class="form-text">
                            <i class="bi bi-lightbulb me-1"></i>
                            æç¤ºï¼šæ‚¨å¯ä»¥è¯¢é—®å›¾åƒçœŸä¼ªã€ç¯¡æ”¹ç—•è¿¹ã€æŠ€æœ¯ç»†èŠ‚ç­‰ä»»ä½•ç›¸å…³é—®é¢˜
                        </div>
                    </div>
                    
                    <!-- æäº¤æŒ‰é’® -->
                    <div class="d-grid gap-2 col-md-6 mx-auto">
                        <button class="btn btn-success btn-lg" type="submit" id="aiDetectionBtn">
                            <span id="aiDetectionBtnText">
                                <i class="bi bi-send me-2"></i>å¼€å§‹AIåˆ†æ
                            </span>
                            <span id="aiDetectionSpinner" class="spinner-border spinner-border-sm d-none ms-2" role="status" aria-hidden="true"></span>
                        </button>
                    </div>
                </form>
                
                <!-- AIå“åº”ç»“æœåŒºåŸŸ -->
                <div class="mt-4 d-none" id="aiResponseContainer">
                    <div class="card border-success">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="bi bi-robot text-success me-2"></i>AIåˆ†æç»“æœ
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="aiResponseContent" class="ai-response-content">
                                <!-- AIå“åº”å†…å®¹å°†åœ¨è¿™é‡Œå®æ—¶æ˜¾ç¤º -->
                            </div>
                            <div id="aiResponseStatus" class="mt-2 text-muted">
                                <i class="bi bi-hourglass-split"></i> æ­£åœ¨åˆ†æä¸­...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- åŠŸèƒ½ç‰¹ç‚¹å¡ç‰‡ -->
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h3 class="mb-0">
                    <i class="bi bi-info-circle me-2"></i>ä½¿ç”¨è¯´æ˜
                </h3>
            </div>
            <div class="card-body">
                <div class="row features-container">
                    <div class="col-md-6 mb-4">
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="bi bi-upload"></i>
                            </div>
                            <div class="feature-content">
                                <h5>ä¸Šä¼ å›¾åƒ</h5>
                                <p>ç‚¹å‡»ä¸Šä¼ åŒºåŸŸé€‰æ‹©è¦æ£€æµ‹çš„å›¾åƒæ–‡ä»¶</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="bi bi-gpu-card"></i>
                            </div>
                            <div class="feature-content">
                                <h5>AIåˆ†æ</h5>
                                <p>æ·±åº¦å­¦ä¹ æ¨¡å‹è‡ªåŠ¨åˆ†æå›¾åƒç‰¹å¾</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="bi bi-check-circle"></i>
                            </div>
                            <div class="feature-content">
                                <h5>æ£€æµ‹ç»“æœ</h5>
                                <p>è·å–å›¾åƒçœŸä¼ªçš„è¯¦ç»†åˆ†æç»“æœ</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="bi bi-shield-lock"></i>
                            </div>
                            <div class="feature-content">
                                <h5>éšç§ä¿æŠ¤</h5>
                                <p>ä¸Šä¼ çš„å›¾åƒä»…ç”¨äºæ£€æµ‹ï¼Œä¸ä¼šå­˜å‚¨</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-warning mt-3">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>æ³¨æ„ï¼š</strong> ç³»ç»ŸåŸºäºæ·±åº¦å­¦ä¹ æ¨¡å‹è¿›è¡Œæ£€æµ‹ï¼Œå¯èƒ½å­˜åœ¨ä¸€å®šçš„è¯¯åˆ¤ç‡ã€‚æ£€æµ‹ç»“æœä»…ä¾›å‚è€ƒï¼Œæœ€ç»ˆåˆ¤æ–­è¯·ç»“åˆä¸“ä¸šçŸ¥è¯†å’Œå…¶ä»–è¯æ®ã€‚
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* é¦–é¡µç‰¹å®šæ ·å¼ */
    .welcome-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9f2ff 100%);
        border-radius: 20px;
    }
    
    .icon-container {
        background-color: rgba(63, 106, 216, 0.1);
        width: 120px;
        height: 120px;
        border-radius: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
    }
    
    .upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 12px;
        padding: 2rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: block;
    }
    
    .upload-area:hover, .upload-area.dragover {
        border-color: var(--primary-color);
        background-color: rgba(63, 106, 216, 0.05);
    }
    
    .feature-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-radius: 10px;
        transition: all 0.3s ease;
        background-color: #f8f9fa;
        height: 100%;
    }
    
    .feature-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .feature-icon {
        width: 50px;
        height: 50px;
        border-radius: 25px;
        background: var(--primary-gradient);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-right: 1rem;
        flex-shrink: 0;
    }
    
    .feature-content {
        flex-grow: 1;
    }
    
    .feature-content h5 {
        margin-bottom: 0.5rem;
        color: var(--dark-color);
    }
    
    .feature-content p {
        margin-bottom: 0;
        color: var(--secondary-color);
    }
    
    /* AIæ£€æµ‹æ¨¡å—æ ·å¼ */
    .ai-detection-form .upload-area {
        border: 2px dashed #28a745;
        border-radius: 12px;
        padding: 2rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: block;
    }
    
    .ai-detection-form .upload-area:hover, 
    .ai-detection-form .upload-area.dragover {
        border-color: #28a745;
        background-color: rgba(40, 167, 69, 0.05);
    }
    
    .ai-detection-form .upload-area.file-selected {
        border-color: #28a745;
        background-color: rgba(40, 167, 69, 0.1);
        border-style: solid;
    }
    
    .ai-response-content {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        min-height: 100px;
        max-height: 500px;
        overflow-y: auto;
        white-space: pre-wrap;
        font-family: system-ui, -apple-system, sans-serif;
        line-height: 1.6;
        border: 1px solid #e9ecef;
    }
    
    .ai-response-content.streaming {
        animation: pulse 2s infinite;
    }
    
    .step-content {
        margin-bottom: 0.5rem;
        padding: 0.25rem 0;
    }
    
    .step-header {
        font-weight: bold;
        color: #28a745;
        margin-bottom: 0.25rem;
    }
    
    .step-content.function-call {
        background-color: rgba(0, 123, 255, 0.1);
        border-left: 3px solid #007bff;
        padding-left: 0.5rem;
        margin: 0.5rem 0;
    }
    
    .step-content.function-result {
        background-color: rgba(40, 167, 69, 0.1);
        border-left: 3px solid #28a745;
        padding-left: 0.5rem;
        margin: 0.5rem 0;
    }
    
    .step-content.ai-analysis {
        background-color: rgba(108, 117, 125, 0.1);
        border-left: 3px solid #6c757d;
        padding-left: 0.5rem;
        margin: 0.5rem 0;
    }
    
    @keyframes pulse {
        0% { border-color: #28a745; }
        50% { border-color: #20c997; }
        100% { border-color: #28a745; }
    }
    
    #queryInput:focus {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }
    
    .typing-indicator {
        display: inline-block;
        animation: typing 1.4s infinite;
    }
    
    @keyframes typing {
        0%, 60%, 100% { opacity: 1; }
        30% { opacity: 0.4; }
    }
    
    /* æ–°å¢ï¼šæ­¥éª¤ä¿¡æ¯æ ·å¼ */
    .step-info {
        font-weight: 500;
        color: #0d6efd;
        background-color: #f8f9fa !important;
        border-radius: 8px;
        animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    #ai-content-area {
        background-color: #ffffff !important;
        border: 1px solid #dee2e6 !important;
        min-height: 100px;
        max-height: 500px;
        overflow-y: auto;
        animation: fadeIn 0.5s ease-in;
        color: #2c3e50 !important;  /* é‡ç½®æ–‡æœ¬é¢œè‰²ä¸ºæ­£å¸¸é»‘è‰² */
    }
    
    /* Markdownå†…å®¹æ ·å¼ */
    .markdown-content h1, .markdown-content h2, .markdown-content h3, 
    .markdown-content h4, .markdown-content h5, .markdown-content h6 {
        color: #2c3e50;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        font-weight: 600;
        line-height: 1.4;
    }
    
    .markdown-content h1 { 
        font-size: 1.8rem; 
        border-bottom: 2px solid #3498db; 
        padding-bottom: 0.5rem; 
        color: #2980b9;
    }
    .markdown-content h2 { 
        font-size: 1.6rem; 
        color: #e74c3c; 
        border-bottom: 1px solid #ecf0f1;
        padding-bottom: 0.3rem;
    }
    .markdown-content h3 { 
        font-size: 1.4rem; 
        color: #27ae60; 
        margin-top: 2rem;
    }
    .markdown-content h4 { 
        font-size: 1.2rem; 
        color: #f39c12; 
        margin-top: 1.8rem;
        font-weight: 700;
    }
    .markdown-content h5 { 
        font-size: 1.1rem; 
        color: #9b59b6; 
        margin-top: 1.5rem;
    }
    .markdown-content h6 { 
        font-size: 1rem; 
        color: #34495e; 
        margin-top: 1.2rem;
    }
    
    /* ç‰¹æ®Šå¤„ç†ï¼šæ ‡é¢˜ä¸­çš„ç²—ä½“æ–‡æœ¬ */
    .markdown-content h1 strong, .markdown-content h2 strong, 
    .markdown-content h3 strong, .markdown-content h4 strong,
    .markdown-content h5 strong, .markdown-content h6 strong {
        color: inherit;
        font-weight: 800;
        text-decoration: none;
    }
    
    /* å››çº§æ ‡é¢˜ç‰¹æ®Šæ ·å¼ï¼ˆå¯¹åº” #### **æ ‡é¢˜** æ ¼å¼ï¼‰*/
    .markdown-content h4 {
        background: linear-gradient(90deg, #fff3cd, #ffffff);
        border-left: 4px solid #f39c12;
        padding: 0.8rem 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin: 1.5rem 0;
    }
    
    .markdown-content h4 strong {
        color: #e67e22;
        font-size: 1.25rem;
    }
    
    .markdown-content p {
        margin-bottom: 1rem;
        line-height: 1.7;
        color: #2c3e50;
    }
    
    .markdown-content ul, .markdown-content ol {
        padding-left: 2rem;
        margin-bottom: 1rem;
    }
    
    .markdown-content li {
        margin-bottom: 0.5rem;
        line-height: 1.6;
    }
    
    /* åˆ—è¡¨é¡¹ä¸­çš„ç²—ä½“æ–‡æœ¬ç‰¹æ®Šå¤„ç† */
    .markdown-content li strong {
        color: #c0392b;
        font-weight: 700;
        background-color: rgba(231, 76, 60, 0.1);
        padding: 0.1rem 0.3rem;
        border-radius: 0.25rem;
    }
    
    .markdown-content strong {
        color: #e74c3c;
        font-weight: 600;
        background-color: rgba(231, 76, 60, 0.05);
        padding: 0.1rem 0.2rem;
        border-radius: 0.2rem;
    }
    
    .markdown-content em {
        color: #8e44ad;
        font-style: italic;
    }
    
    .markdown-content code {
        background-color: #f8f9fa;
        color: #e83e8c;
        padding: 0.2rem 0.4rem;
        border-radius: 0.25rem;
        font-size: 0.875em;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    }
    
    .markdown-content pre {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 0.5rem;
        padding: 1rem;
        overflow-x: auto;
        margin-bottom: 1rem;
    }
    
    .markdown-content pre code {
        background: none;
        color: #495057;
        padding: 0;
    }
    
    .markdown-content blockquote {
        border-left: 4px solid #007bff;
        background-color: #f8f9fa;
        padding: 1rem 1.5rem;
        margin: 1rem 0;
        font-style: italic;
        color: #6c757d;
    }
    
    .markdown-content table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
        background-color: #ffffff;
    }
    
    .markdown-content th, .markdown-content td {
        border: 1px solid #dee2e6;
        padding: 0.75rem;
        text-align: left;
    }
    
    .markdown-content th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #495057;
    }
    
    .markdown-content tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    
    .markdown-content hr {
        border: none;
        border-top: 3px solid #3498db;
        margin: 2.5rem 0;
        background: linear-gradient(90deg, #3498db, #2ecc71, #3498db);
        height: 3px;
        border-radius: 2px;
    }
    
    /* åˆ†éš”çº¿åç´§è·Ÿæ ‡é¢˜çš„ç‰¹æ®Šå¤„ç† */
    .markdown-content hr + h1,
    .markdown-content hr + h2,
    .markdown-content hr + h3,
    .markdown-content hr + h4,
    .markdown-content hr + h5,
    .markdown-content hr + h6 {
        margin-top: 1rem;
    }
    
    /* å¢å¼ºæ®µè½é—´è·å’Œåˆ†éš”æ„Ÿ */
    .markdown-content > *:first-child {
        margin-top: 0;
    }
    
    .markdown-content > *:last-child {
        margin-bottom: 0;
    }
    
    /* å¤„ç†æ¢è¡Œç¬¦æ˜¾ç¤º */
    .markdown-content {
        white-space: normal;
    }
    
    .markdown-content br {
        line-height: 1.5;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- æ·»åŠ Markdownè§£æåº“ -->
<script src="https://cdn.jsdelivr.net/npm/marked@5.1.1/marked.min.js"></script>
<script>
    // é…ç½®Markdownè§£æå™¨
    marked.setOptions({
        breaks: true,        // æ”¯æŒæ¢è¡Œç¬¦è½¬æ¢ä¸º<br>
        gfm: true,          // å¯ç”¨GitHubé£æ ¼çš„Markdown
        sanitize: false,     // å…è®¸HTMLæ ‡ç­¾
        smartLists: true,    // æ™ºèƒ½åˆ—è¡¨å¤„ç†
        smartypants: false,  // ç¦ç”¨æ™ºèƒ½æ ‡ç‚¹ç¬¦å·è½¬æ¢
        mangle: false,       // ç¦ç”¨mangleé¿å…è­¦å‘Š
        headerIds: false     // ç¦ç”¨headerIdsé¿å…è­¦å‘Š
    });
    
    // è‡ªå®šä¹‰æ¸²æŸ“å‡½æ•°æ¥å¤„ç†ç‰¹æ®Šæ ¼å¼
    function renderMarkdownContent(content) {
        // ç®€åŒ–å¤„ç†ï¼ŒåªåšåŸºæœ¬çš„Markdownè§£æ
        return marked.parse(content);
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // æ‹–æ”¾åŠŸèƒ½
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('file');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        
        if (uploadArea && fileInput) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                uploadArea.classList.add('dragover');
            }
            
            function unhighlight() {
                uploadArea.classList.remove('dragover');
            }
            
            uploadArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if(files.length) {
                    fileInput.files = files;
                    // è§¦å‘changeäº‹ä»¶ï¼Œä½¿æ–‡ä»¶é¢„è§ˆåŠŸèƒ½å·¥ä½œ
                    const event = new Event('change', { bubbles: true });
                    fileInput.dispatchEvent(event);
                }
            }
            
            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸæ—¶è§¦å‘æ–‡ä»¶é€‰æ‹©
            uploadArea.addEventListener('click', function(e) {
                // åªæœ‰å½“é¢„è§ˆåŒºåŸŸéšè—æˆ–ç‚¹å‡»çš„ä¸æ˜¯é¢„è§ˆåŒºåŸŸå†…çš„å…ƒç´ æ—¶æ‰è§¦å‘
                const isPreviewShown = !imagePreviewContainer.classList.contains('d-none');
                
                if (!isPreviewShown || !imagePreviewContainer.contains(e.target)) {
                    fileInput.click();
                }
            });
        }
        
        // AIæ£€æµ‹åŠŸèƒ½
        const aiUploadArea = document.getElementById('aiUploadArea');
        const aiFileInput = document.getElementById('aiFile');
        const aiImagePreviewContainer = document.getElementById('aiImagePreviewContainer');
        const aiDetectionForm = document.getElementById('aiDetectionForm');
        const aiResponseContainer = document.getElementById('aiResponseContainer');
        const aiResponseContent = document.getElementById('aiResponseContent');
        const aiResponseStatus = document.getElementById('aiResponseStatus');
        const aiDetectionBtn = document.getElementById('aiDetectionBtn');
        const aiDetectionBtnText = document.getElementById('aiDetectionBtnText');
        const aiDetectionSpinner = document.getElementById('aiDetectionSpinner');
        
        if (aiUploadArea && aiFileInput) {
            // AIä¸Šä¼ åŒºåŸŸæ‹–æ”¾åŠŸèƒ½
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                aiUploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                aiUploadArea.addEventListener(eventName, () => {
                    aiUploadArea.classList.add('dragover');
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                aiUploadArea.addEventListener(eventName, () => {
                    aiUploadArea.classList.remove('dragover');
                }, false);
            });
            
            aiUploadArea.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if(files.length) {
                    aiFileInput.files = files;
                    const event = new Event('change', { bubbles: true });
                    aiFileInput.dispatchEvent(event);
                }
            }, false);
            
            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
            aiUploadArea.addEventListener('click', function(e) {
                const isPreviewShown = !aiImagePreviewContainer.classList.contains('d-none');
                if (!isPreviewShown || !aiImagePreviewContainer.contains(e.target)) {
                    aiFileInput.click();
                }
            });
            
            // æ–‡ä»¶é€‰æ‹©é¢„è§ˆ
            aiFileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    
                    // æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
                    aiImagePreviewContainer.innerHTML = '<div class="spinner-border text-success" role="status"><span class="visually-hidden">åŠ è½½ä¸­...</span></div>';
                    aiImagePreviewContainer.classList.remove('d-none');
                    
                    reader.onload = function(e) {
                        // åˆ›å»ºå›¾åƒå¯¹è±¡ä»¥è·å–å°ºå¯¸
                        const img = new Image();
                        img.onload = function() {
                            // æ›´æ–°é¢„è§ˆå®¹å™¨å†…å®¹
                            aiImagePreviewContainer.innerHTML = `
                                <h5>å›¾åƒé¢„è§ˆ</h5>
                                <div class="image-details mb-2">
                                    <span class="badge bg-info me-2">${file.type.split('/')[1].toUpperCase()}</span>
                                    <span class="badge bg-secondary me-2">${Math.round(file.size / 1024)} KB</span>
                                    <span class="badge bg-dark">${this.width} Ã— ${this.height}</span>
                                </div>
                                <div class="image-preview-wrapper">
                                    <img id="aiImagePreview" class="img-fluid img-thumbnail mt-2" style="max-height: 300px;" src="${e.target.result}" alt="å›¾åƒé¢„è§ˆ">
                                </div>
                                <div class="preview-actions mt-3 d-flex justify-content-between align-items-center">
                                    <button type="button" class="btn btn-sm btn-outline-secondary btn-reset-upload" onclick="clearAiPreview()">
                                        <i class="bi bi-x-circle me-1"></i>é‡æ–°é€‰æ‹©
                                    </button>
                                    <div class="preview-info text-muted">
                                        <small><i class="bi bi-info-circle me-1"></i>å¯è¾“å…¥é—®é¢˜åç‚¹å‡»"å¼€å§‹AIåˆ†æ"æŒ‰é’®</small>
                                    </div>
                                </div>
                            `;
                            
                            // åˆ‡æ¢ä¸Šä¼ åŒºåŸŸæ ·å¼
                            aiUploadArea.classList.add('file-selected');
                            
                            // æ·»åŠ æ·¡å…¥åŠ¨ç”»æ•ˆæœ
                            const newImage = aiImagePreviewContainer.querySelector('#aiImagePreview');
                            if (newImage) {
                                newImage.style.opacity = '0';
                                setTimeout(() => {
                                    newImage.style.transition = 'opacity 0.5s ease';
                                    newImage.style.opacity = '1';
                                }, 50);
                            }
                        };
                        img.src = e.target.result;
                    };
                    
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // AIæ£€æµ‹è¡¨å•æäº¤
        if (aiDetectionForm) {
            aiDetectionForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(aiDetectionForm);
                
                if (!formData.get('file') || !formData.get('query').trim()) {
                    alert('è¯·ä¸Šä¼ å›¾ç‰‡å¹¶è¾“å…¥é—®é¢˜ï¼');
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                aiDetectionBtn.disabled = true;
                aiDetectionBtnText.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>æ­£åœ¨åˆ†æ...';
                aiDetectionSpinner.classList.remove('d-none');
                
                // æ˜¾ç¤ºå“åº”å®¹å™¨å¹¶æ¸…ç©ºå†…å®¹
                aiResponseContainer.classList.remove('d-none');
                aiResponseContent.innerHTML = '';
                aiResponseContent.classList.add('streaming');
                aiResponseStatus.innerHTML = '<i class="bi bi-hourglass-split"></i> AIæ­£åœ¨åˆ†æå›¾åƒ<span class="typing-indicator">...</span>';
                
                // çŠ¶æ€ç®¡ç†
                let currentPhase = 'progress'; // progress -> content
                let contentBuffer = '';
                
                try {
                    const response = await fetch('/api/ai/predict/stream', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                    }
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                
                                if (data === '[DONE]') {
                                    // æµç»“æŸ
                                    aiResponseContent.classList.remove('streaming');
                                    aiResponseStatus.innerHTML = '<i class="bi bi-check-circle text-success"></i> åˆ†æå®Œæˆ';
                                    break;
                                } else if (data.trim()) {
                                    // æ£€æµ‹æ˜¯å¦ä¸ºæ­¥éª¤è¿›åº¦ä¿¡æ¯
                                    if (data.includes('æ­¥éª¤') && (data.includes('ğŸš€') || data.includes('âœ…') || data.includes('ğŸ¤–') || data.includes('ğŸ“') || data.includes('ğŸ”') || data.includes('ğŸ’­'))) {
                                        // è¿™æ˜¯æ­¥éª¤ä¿¡æ¯ï¼Œç›´æ¥æ·»åŠ åˆ°å†…å®¹åŒºåŸŸ
                                        const stepDiv = document.createElement('div');
                                        stepDiv.className = 'step-info mb-2 p-2 bg-light border-start border-primary border-3';
                                        stepDiv.innerHTML = data;
                                        aiResponseContent.appendChild(stepDiv);
                                        
                                        // å¦‚æœæ˜¯"æ­¥éª¤5ï¼šæ­£åœ¨ç”ŸæˆAIåˆ†ææŠ¥å‘Š"ï¼Œåˆ‡æ¢åˆ°å†…å®¹æ¨¡å¼
                                        if (data.includes('ğŸ’­ æ­¥éª¤5ï¼šæ­£åœ¨ç”ŸæˆAIåˆ†ææŠ¥å‘Š')) {
                                            currentPhase = 'content';
                                            // åˆ›å»ºå†…å®¹æ˜¾ç¤ºåŒºåŸŸ
                                            const contentDiv = document.createElement('div');
                                            contentDiv.id = 'ai-content-area';
                                            contentDiv.className = 'mt-3 p-3 bg-white border rounded markdown-content';
                                            contentDiv.style.fontFamily = 'system-ui, -apple-system, sans-serif';
                                            contentDiv.style.lineHeight = '1.6';
                                            aiResponseContent.appendChild(contentDiv);
                                        }
                                    } else if (data.startsWith('FULL:')) {
                                        // å®Œæ•´å†…å®¹æ›¿æ¢
                                        const content = data.substring(5); // ç§»é™¤ 'FULL:' å‰ç¼€
                                        const contentArea = document.getElementById('ai-content-area');
                                        if (contentArea) {
                                            contentBuffer = content;
                                            contentArea.innerHTML = renderMarkdownContent(contentBuffer);
                                        }
                                    } else if (data.startsWith('INCREMENT:')) {
                                        // å¢é‡å†…å®¹è¿½åŠ 
                                        const newContent = data.substring(10); // ç§»é™¤ 'INCREMENT:' å‰ç¼€
                                        const contentArea = document.getElementById('ai-content-area');
                                        if (contentArea) {
                                            contentBuffer += newContent;
                                            contentArea.innerHTML = renderMarkdownContent(contentBuffer);
                                        }
                                    } else if (currentPhase === 'content') {
                                        // å…¼å®¹æ—§æ ¼å¼ï¼šè¿™æ˜¯AIåˆ†æå†…å®¹ï¼Œè¿½åŠ åˆ°å†…å®¹åŒºåŸŸ
                                        const contentArea = document.getElementById('ai-content-area');
                                        if (contentArea) {
                                            contentBuffer += data;
                                            contentArea.innerHTML = renderMarkdownContent(contentBuffer);
                                        }
                                    }
                                    
                                    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                                    aiResponseContent.scrollTop = aiResponseContent.scrollHeight;
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('AIæ£€æµ‹è¯·æ±‚å¤±è´¥:', error);
                    aiResponseContent.classList.remove('streaming');
                    aiResponseContent.innerHTML = '<div class="text-danger"><i class="bi bi-exclamation-triangle"></i> è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
                    aiResponseStatus.innerHTML = '<i class="bi bi-x-circle text-danger"></i> åˆ†æå¤±è´¥';
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    aiDetectionBtn.disabled = false;
                    aiDetectionBtnText.innerHTML = '<i class="bi bi-send me-2"></i>å¼€å§‹AIåˆ†æ';
                    aiDetectionSpinner.classList.add('d-none');
                }
            });
        }
        
        // ç‰¹æ€§é¡¹åŠ¨ç”»
        const features = document.querySelectorAll('.feature-item');
        features.forEach((feature, index) => {
            feature.style.setProperty('--child-index', index);
            feature.classList.add('animate-ready');
            
            // è®¾ç½®äº¤é”™åŠ¨ç”»æ—¶é—´
            setTimeout(() => {
                feature.classList.add('animate-in');
            }, 100 * index);
        });
    });
    
    // æ¸…é™¤AIé¢„è§ˆå›¾ç‰‡çš„å…¨å±€å‡½æ•°
    function clearAiPreview() {
        const aiImagePreviewContainer = document.getElementById('aiImagePreviewContainer');
        const aiFileInput = document.getElementById('aiFile');
        const aiUploadArea = document.getElementById('aiUploadArea');
        
        if (aiImagePreviewContainer) {
            aiImagePreviewContainer.classList.add('d-none');
            aiImagePreviewContainer.innerHTML = '';
        }
        
        if (aiFileInput) {
            aiFileInput.value = '';
        }
        
        // ç§»é™¤ä¸Šä¼ åŒºåŸŸé€‰ä¸­çŠ¶æ€
        if (aiUploadArea) {
            aiUploadArea.classList.remove('file-selected');
        }
    }
    
    // å›¾åƒé¢„è§ˆåŠŸèƒ½å·²ç»ç”±main.jsä¸­çš„å‡½æ•°å¢å¼ºå¤„ç†
</script>
{% endblock %} 